{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .inventory-table {
        font-size: 0.9rem;
    }
    
    .version-badge {
        font-family: monospace;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .update-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .update-available {
        background-color: #ffc107;
    }
    
    .up-to-date {
        background-color: #28a745;
    }
    
    .status-unknown {
        background-color: #6c757d;
    }
    
    .filter-controls {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .export-buttons {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Firmware Inventory</h1>
                    <p class="text-muted">Detailed firmware status across all servers</p>
                </div>
                <div>
                    <a href="{{ url_for('firmware.firmware_dashboard') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                    <button class="btn btn-primary" onclick="refreshInventory()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ inventory.update_summary.total_servers }}</h3>
                    <p class="mb-0">Total Servers</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ inventory.update_summary.updates_available }}</h3>
                    <p class="mb-0">Updates Available</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ inventory.update_summary.up_to_date }}</h3>
                    <p class="mb-0">Up to Date</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-secondary">{{ inventory.update_summary.unknown_status }}</h3>
                    <p class="mb-0">Unknown Status</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Export Controls -->
    <div class="filter-controls">
        <div class="row align-items-center">
            <div class="col-md-6">
                <label class="form-label">Filter by Status:</label>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="filterAll">All</label>
                    
                    <input type="radio" class="btn-check" name="statusFilter" id="filterUpdates" value="updates">
                    <label class="btn btn-outline-warning btn-sm" for="filterUpdates">Updates Available</label>
                    
                    <input type="radio" class="btn-check" name="statusFilter" id="filterCurrent" value="current">
                    <label class="btn btn-outline-success btn-sm" for="filterCurrent">Up to Date</label>
                    
                    <input type="radio" class="btn-check" name="statusFilter" id="filterUnknown" value="unknown">
                    <label class="btn btn-outline-secondary btn-sm" for="filterUnknown">Unknown</label>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="exportToJSON()">
                    <i class="fas fa-download"></i> Export JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Inventory Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-list"></i> Server Firmware Inventory
            </h5>
        </div>
        <div class="card-body">
            {% if inventory.servers %}
            <div class="table-responsive">
                <table class="table table-hover inventory-table" id="inventoryTable">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" class="form-check-input">
                            </th>
                            <th>Server</th>
                            <th>Status</th>
                            <th>Device Type</th>
                            <th>BIOS Version</th>
                            <th>BMC Version</th>
                            <th>Updates</th>
                            <th>Last Checked</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for server in inventory.servers %}
                        <tr class="server-row" 
                            data-status="{{ 'updates' if server.updates_available else ('current' if server.firmware_status == 'detected' else 'unknown') }}">
                            <td>
                                <input type="checkbox" class="form-check-input server-checkbox" value="{{ server.id }}">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="update-indicator {{ 'update-available' if server.updates_available else ('up-to-date' if server.firmware_status == 'detected' else 'status-unknown') }}"></span>
                                    <div>
                                        <strong>{{ server.hostname }}</strong>
                                        <br><small class="text-muted">ID: {{ server.id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if server.updates_available %}
                                    <span class="badge bg-warning">Updates Available</span>
                                {% elif server.firmware_status == 'detected' %}
                                    <span class="badge bg-success">Up to Date</span>
                                {% else %}
                                    <span class="badge bg-secondary">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ server.device_type or 'Unknown' }}</span>
                            </td>
                            <td>
                                <span class="version-badge badge bg-info">{{ server.bios_version }}</span>
                            </td>
                            <td>
                                <span class="version-badge badge bg-info">{{ server.bmc_version }}</span>
                            </td>
                            <td>
                                {% if server.updates_available and server.available_updates %}
                                    {% for update in server.available_updates %}
                                    <div class="small">
                                        <span class="badge bg-warning text-dark">{{ update.component }}</span>
                                        {{ update.available }}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">None</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if server.last_checked %}
                                    <span class="small">{{ moment(server.last_checked).format('MMM DD, HH:mm') }}</span>
                                {% else %}
                                    <span class="text-muted">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if server.updates_available %}
                                    <button class="btn btn-warning btn-sm" onclick="scheduleUpdate('{{ server.id }}')" title="Schedule Update">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewDetails('{{ server.id }}')" title="View Details">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="checkFirmware('{{ server.id }}')" title="Check Firmware">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Bulk Actions -->
            <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span id="selectedCount">0</span> servers selected
                    </div>
                    <div>
                        <button class="btn btn-warning" id="bulkUpdateBtn" disabled onclick="bulkScheduleUpdate()">
                            <i class="fas fa-download"></i> Schedule Updates for Selected
                        </button>
                        <button class="btn btn-outline-primary" id="bulkCheckBtn" disabled onclick="bulkCheckFirmware()">
                            <i class="fas fa-search"></i> Check Selected
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-server fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No servers found</h5>
                <p class="text-muted">Add servers to your infrastructure to view firmware inventory</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Server Details Modal -->
<div class="modal fade" id="serverDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Firmware Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="serverDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let selectedServers = new Set();

function refreshInventory() {
    // Show loading state
    const refreshBtn = document.querySelector('button[onclick="refreshInventory()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    // Reload the page to get fresh data
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function filterServers() {
    const selectedFilter = document.querySelector('input[name="statusFilter"]:checked').value;
    const serverRows = document.querySelectorAll('.server-row');
    let visibleCount = 0;
    
    serverRows.forEach(row => {
        const status = row.getAttribute('data-status');
        if (selectedFilter === 'all' || status === selectedFilter) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
            // Uncheck hidden rows
            const checkbox = row.querySelector('.server-checkbox');
            if (checkbox.checked) {
                checkbox.checked = false;
                selectedServers.delete(checkbox.value);
            }
        }
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedServers.size;
    
    const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
    const bulkCheckBtn = document.getElementById('bulkCheckBtn');
    
    if (selectedServers.size > 0) {
        bulkUpdateBtn.disabled = false;
        bulkCheckBtn.disabled = false;
    } else {
        bulkUpdateBtn.disabled = true;
        bulkCheckBtn.disabled = true;
    }
}

function toggleServerSelection(serverId, checked) {
    if (checked) {
        selectedServers.add(serverId);
    } else {
        selectedServers.delete(serverId);
    }
    updateSelectedCount();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const serverCheckboxes = document.querySelectorAll('.server-checkbox');
    const visibleCheckboxes = Array.from(serverCheckboxes).filter(cb => 
        cb.closest('tr').style.display !== 'none'
    );
    
    if (selectAllCheckbox.checked) {
        visibleCheckboxes.forEach(cb => {
            cb.checked = true;
            selectedServers.add(cb.value);
        });
    } else {
        visibleCheckboxes.forEach(cb => {
            cb.checked = false;
            selectedServers.delete(cb.value);
        });
    }
    
    updateSelectedCount();
}

function scheduleUpdate(serverId) {
    window.location.href = `{{ url_for('firmware.firmware_schedule') }}?server=${serverId}`;
}

function bulkScheduleUpdate() {
    if (selectedServers.size === 0) return;
    
    const serverIds = Array.from(selectedServers).join(',');
    window.location.href = `{{ url_for('firmware.firmware_schedule') }}?servers=${serverIds}`;
}

function viewDetails(serverId) {
    const modal = new bootstrap.Modal(document.getElementById('serverDetailsModal'));
    const content = document.getElementById('serverDetailsContent');
    
    content.innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Loading firmware details...</p>
        </div>
    `;
    
    modal.show();
    
    // Simulate loading detailed firmware information
    setTimeout(() => {
        content.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Server Information</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Server ID:</strong> ${serverId}</p>
                            <p><strong>Hostname:</strong> server-${serverId}</p>
                            <p><strong>Status:</strong> Ready</p>
                            <p><strong>Device Type:</strong> a1.c5.large</p>
                            <p><strong>IPMI IP:</strong> 192.168.1.100</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Current Firmware</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>BIOS Version:</strong> <span class="badge bg-info">Simulated-v1.0</span></p>
                            <p><strong>BMC Version:</strong> <span class="badge bg-info">Simulated-BMC-v2.0</span></p>
                            <p><strong>Last Updated:</strong> 2 weeks ago</p>
                            <p><strong>Update Method:</strong> Redfish + Vendor Tools</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Available Updates</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <span class="badge bg-warning">BIOS</span>
                                v1.0 → v1.2 (Recommended)
                            </div>
                            <div class="mb-2">
                                <span class="badge bg-warning">BMC</span>
                                v2.0 → v2.1 (Optional)
                            </div>
                            <button class="btn btn-warning btn-sm mt-2">
                                Schedule Updates
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Firmware Update History</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Component</th>
                                            <th>From Version</th>
                                            <th>To Version</th>
                                            <th>Method</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>2024-07-20 14:30</td>
                                            <td>BIOS</td>
                                            <td>v0.9</td>
                                            <td>v1.0</td>
                                            <td>Redfish</td>
                                            <td>8m 32s</td>
                                            <td><span class="badge bg-success">Success</span></td>
                                        </tr>
                                        <tr>
                                            <td>2024-07-15 09:15</td>
                                            <td>BMC</td>
                                            <td>v1.9</td>
                                            <td>v2.0</td>
                                            <td>Vendor Tool</td>
                                            <td>12m 15s</td>
                                            <td><span class="badge bg-success">Success</span></td>
                                        </tr>
                                        <tr>
                                            <td>2024-07-10 16:45</td>
                                            <td>BIOS</td>
                                            <td>v0.8</td>
                                            <td>v0.9</td>
                                            <td>Redfish</td>
                                            <td>7m 45s</td>
                                            <td><span class="badge bg-success">Success</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }, 1000);
}

function checkFirmware(serverId) {
    // Simulate firmware check
    alert(`Checking firmware for server ${serverId}...`);
}

function bulkCheckFirmware() {
    if (selectedServers.size === 0) return;
    
    alert(`Checking firmware for ${selectedServers.size} selected servers...`);
}

function exportToCSV() {
    // Simple CSV export implementation
    const rows = [];
    const headers = ['Server ID', 'Hostname', 'Status', 'Device Type', 'BIOS Version', 'BMC Version', 'Updates Available'];
    rows.push(headers.join(','));
    
    {% for server in inventory.servers %}
    rows.push([
        '{{ server.id }}',
        '{{ server.hostname }}',
        '{{ "Updates Available" if server.updates_available else ("Up to Date" if server.firmware_status == "detected" else "Unknown") }}',
        '{{ server.device_type or "Unknown" }}',
        '{{ server.bios_version }}',
        '{{ server.bmc_version }}',
        '{{ "Yes" if server.updates_available else "No" }}'
    ].join(','));
    {% endfor %}
    
    const csvContent = rows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `firmware-inventory-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function exportToJSON() {
    const data = {{ inventory | tojson }};
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `firmware-inventory-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Set up event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Filter event listeners
    document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
        radio.addEventListener('change', filterServers);
    });
    
    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
    
    // Individual server checkboxes
    document.querySelectorAll('.server-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            toggleServerSelection(this.value, this.checked);
        });
    });
    
    // Initialize selected count
    updateSelectedCount();
});
</script>
{% endblock %}
