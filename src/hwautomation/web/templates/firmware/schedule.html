{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .schedule-card {
        border: 1px solid #e3e6f0;
        border-radius: 0.35rem;
        transition: all 0.3s ease;
    }
    
    .schedule-card:hover {
        box-shadow: 0 0.15rem 1.75rem rgba(58, 59, 69, 0.15);
    }
    
    .server-selection-card {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .component-checkbox {
        margin-bottom: 0.5rem;
    }
    
    .maintenance-window {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
    }
    
    .schedule-summary {
        background-color: #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
    }
    
    .server-list-item {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        background-color: white;
    }
    
    .server-list-item.selected {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
    
    .datetime-input {
        background-color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Schedule Firmware Updates</h1>
                    <p class="text-muted">Plan and schedule firmware updates for your servers</p>
                </div>
                <div>
                    <a href="{{ url_for('firmware.firmware_dashboard') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                    <button class="btn btn-outline-primary" onclick="loadTemplate()">
                        <i class="fas fa-file-import"></i> Load Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Form -->
    <form id="scheduleForm">
        <div class="row">
            <!-- Server Selection -->
            <div class="col-lg-6">
                <div class="card schedule-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-server"></i> Select Servers
                        </h5>
                    </div>
                    <div class="card-body server-selection-card">
                        <div class="mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="serverSearch" placeholder="Search servers...">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAll()">
                                Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="selectNone()">
                                Select None
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectUpdatesAvailable()">
                                Select Updates Available
                            </button>
                        </div>
                        
                        <div id="serverList">
                            {% for server in servers %}
                            <div class="server-list-item" data-server-id="{{ server.id }}" onclick="toggleServer('{{ server.id }}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ server.hostname }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            ID: {{ server.id }} | Type: {{ server.device_type or 'Unknown' }}
                                        </small>
                                        {% if server.updates_available %}
                                        <br>
                                        <span class="badge bg-warning text-dark">Updates Available</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <input type="checkbox" class="form-check-input server-checkbox" 
                                               value="{{ server.id }}" onchange="updateServerSelection()">
                                    </div>
                                </div>
                                {% if server.updates_available and server.available_updates %}
                                <div class="mt-2">
                                    {% for update in server.available_updates %}
                                    <small class="badge bg-light text-dark me-1">
                                        {{ update.component }}: {{ update.current }} â†’ {{ update.available }}
                                    </small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Update Configuration -->
            <div class="col-lg-6">
                <div class="card schedule-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cog"></i> Update Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Components Selection -->
                        <div class="mb-4">
                            <label class="form-label">Components to Update:</label>
                            <div class="component-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="biosUpdate" value="bios" checked>
                                    <label class="form-check-label" for="biosUpdate">
                                        <strong>BIOS Firmware</strong>
                                        <br><small class="text-muted">System BIOS/UEFI updates</small>
                                    </label>
                                </div>
                            </div>
                            <div class="component-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="bmcUpdate" value="bmc" checked>
                                    <label class="form-check-label" for="bmcUpdate">
                                        <strong>BMC Firmware</strong>
                                        <br><small class="text-muted">Baseboard Management Controller updates</small>
                                    </label>
                                </div>
                            </div>
                            <div class="component-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="nicUpdate" value="nic">
                                    <label class="form-check-label" for="nicUpdate">
                                        <strong>Network Interface Cards</strong>
                                        <br><small class="text-muted">NIC firmware updates (if available)</small>
                                    </label>
                                </div>
                            </div>
                            <div class="component-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="storageUpdate" value="storage">
                                    <label class="form-check-label" for="storageUpdate">
                                        <strong>Storage Controllers</strong>
                                        <br><small class="text-muted">RAID/HBA controller firmware</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Scheduling Options -->
                        <div class="mb-4">
                            <label class="form-label">Schedule Type:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scheduleType" id="immediate" value="immediate" checked>
                                <label class="form-check-label" for="immediate">
                                    Start Immediately
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scheduleType" id="scheduled" value="scheduled">
                                <label class="form-check-label" for="scheduled">
                                    Schedule for Later
                                </label>
                            </div>
                        </div>

                        <!-- Scheduled Time (hidden by default) -->
                        <div id="scheduledTimeSection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Scheduled Start Time:</label>
                                <input type="datetime-local" class="form-control datetime-input" id="scheduledTime">
                            </div>
                        </div>

                        <!-- Maintenance Window -->
                        <div class="maintenance-window">
                            <label class="form-label">Maintenance Window:</label>
                            <div class="row">
                                <div class="col-6">
                                    <select class="form-select" id="maintenanceWindow">
                                        <option value="30">30 minutes</option>
                                        <option value="60" selected>1 hour</option>
                                        <option value="120">2 hours</option>
                                        <option value="240">4 hours</option>
                                        <option value="480">8 hours</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="rollbackEnabled" checked>
                                        <label class="form-check-label" for="rollbackEnabled">
                                            Enable automatic rollback
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Options -->
                        <div class="mt-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="preValidation" checked>
                                <label class="form-check-label" for="preValidation">
                                    Pre-update validation
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="postValidation" checked>
                                <label class="form-check-label" for="postValidation">
                                    Post-update validation
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyOnCompletion" checked>
                                <label class="form-check-label" for="notifyOnCompletion">
                                    Send notification on completion
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Summary -->
        <div class="row">
            <div class="col-12">
                <div class="card schedule-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list-check"></i> Schedule Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="schedule-summary">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Selected Servers:</strong> <span id="selectedServerCount">0</span></p>
                                    <p><strong>Components:</strong> <span id="selectedComponents">BIOS, BMC</span></p>
                                    <p><strong>Schedule Type:</strong> <span id="scheduleTypeSummary">Immediate</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Maintenance Window:</strong> <span id="maintenanceWindowSummary">1 hour</span></p>
                                    <p><strong>Estimated Duration:</strong> <span id="estimatedDuration">45 minutes per server</span></p>
                                    <p><strong>Rollback Enabled:</strong> <span id="rollbackSummary">Yes</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="saveTemplate()">
                                    <i class="fas fa-save"></i> Save as Template
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" onclick="previewSchedule()">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button type="submit" class="btn btn-success" id="scheduleButton" disabled>
                                    <i class="fas fa-play"></i> Schedule Updates
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Firmware Update Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="confirmSchedule()">
                    Confirm Schedule
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let selectedServers = new Set();

document.addEventListener('DOMContentLoaded', function() {
    // Pre-select servers from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const serverParam = urlParams.get('server');
    const serversParam = urlParams.get('servers');
    
    if (serverParam) {
        selectServer(serverParam);
    } else if (serversParam) {
        serversParam.split(',').forEach(serverId => {
            selectServer(serverId.trim());
        });
    }
    
    // Set up event listeners
    setupEventListeners();
    updateSummary();
});

function setupEventListeners() {
    // Schedule type radio buttons
    document.querySelectorAll('input[name="scheduleType"]').forEach(radio => {
        radio.addEventListener('change', toggleScheduledTime);
    });
    
    // Component checkboxes
    document.querySelectorAll('.component-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateSummary);
    });
    
    // Maintenance window
    document.getElementById('maintenanceWindow').addEventListener('change', updateSummary);
    
    // Rollback checkbox
    document.getElementById('rollbackEnabled').addEventListener('change', updateSummary);
    
    // Search functionality
    document.getElementById('serverSearch').addEventListener('input', filterServers);
    
    // Form submission
    document.getElementById('scheduleForm').addEventListener('submit', handleFormSubmit);
}

function toggleScheduledTime() {
    const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
    const scheduledTimeSection = document.getElementById('scheduledTimeSection');
    
    if (scheduleType === 'scheduled') {
        scheduledTimeSection.style.display = 'block';
        // Set minimum time to 30 minutes from now
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        document.getElementById('scheduledTime').min = now.toISOString().slice(0, 16);
    } else {
        scheduledTimeSection.style.display = 'none';
    }
    
    updateSummary();
}

function selectServer(serverId) {
    selectedServers.add(serverId);
    const serverItem = document.querySelector(`[data-server-id="${serverId}"]`);
    const checkbox = document.querySelector(`input[value="${serverId}"]`);
    
    if (serverItem) {
        serverItem.classList.add('selected');
    }
    if (checkbox) {
        checkbox.checked = true;
    }
    
    updateSummary();
}

function toggleServer(serverId) {
    const checkbox = document.querySelector(`input[value="${serverId}"]`);
    checkbox.checked = !checkbox.checked;
    updateServerSelection();
}

function updateServerSelection() {
    selectedServers.clear();
    
    document.querySelectorAll('.server-checkbox:checked').forEach(checkbox => {
        selectedServers.add(checkbox.value);
        const serverItem = document.querySelector(`[data-server-id="${checkbox.value}"]`);
        if (serverItem) {
            serverItem.classList.add('selected');
        }
    });
    
    document.querySelectorAll('.server-checkbox:not(:checked)').forEach(checkbox => {
        const serverItem = document.querySelector(`[data-server-id="${checkbox.value}"]`);
        if (serverItem) {
            serverItem.classList.remove('selected');
        }
    });
    
    updateSummary();
}

function selectAll() {
    document.querySelectorAll('.server-checkbox').forEach(checkbox => {
        if (checkbox.closest('.server-list-item').style.display !== 'none') {
            checkbox.checked = true;
        }
    });
    updateServerSelection();
}

function selectNone() {
    document.querySelectorAll('.server-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateServerSelection();
}

function selectUpdatesAvailable() {
    document.querySelectorAll('.server-checkbox').forEach(checkbox => {
        const serverItem = checkbox.closest('.server-list-item');
        const hasUpdates = serverItem.querySelector('.badge.bg-warning');
        
        if (hasUpdates && serverItem.style.display !== 'none') {
            checkbox.checked = true;
        } else {
            checkbox.checked = false;
        }
    });
    updateServerSelection();
}

function filterServers() {
    const searchTerm = document.getElementById('serverSearch').value.toLowerCase();
    document.querySelectorAll('.server-list-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function clearSearch() {
    document.getElementById('serverSearch').value = '';
    filterServers();
}

function updateSummary() {
    // Update selected server count
    document.getElementById('selectedServerCount').textContent = selectedServers.size;
    
    // Update selected components
    const selectedComponents = [];
    document.querySelectorAll('.component-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
        selectedComponents.push(checkbox.nextElementSibling.querySelector('strong').textContent);
    });
    document.getElementById('selectedComponents').textContent = selectedComponents.join(', ') || 'None';
    
    // Update schedule type
    const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
    document.getElementById('scheduleTypeSummary').textContent = scheduleType === 'immediate' ? 'Immediate' : 'Scheduled';
    
    // Update maintenance window
    const window = document.getElementById('maintenanceWindow').value;
    const windowText = window === '30' ? '30 minutes' : 
                      window === '60' ? '1 hour' : 
                      window === '120' ? '2 hours' : 
                      window === '240' ? '4 hours' : '8 hours';
    document.getElementById('maintenanceWindowSummary').textContent = windowText;
    
    // Update rollback status
    const rollback = document.getElementById('rollbackEnabled').checked;
    document.getElementById('rollbackSummary').textContent = rollback ? 'Yes' : 'No';
    
    // Enable/disable schedule button
    const scheduleButton = document.getElementById('scheduleButton');
    if (selectedServers.size > 0 && selectedComponents.length > 0) {
        scheduleButton.disabled = false;
    } else {
        scheduleButton.disabled = true;
    }
}

function previewSchedule() {
    if (selectedServers.size === 0) {
        alert('Please select at least one server.');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    const content = document.getElementById('previewContent');
    
    // Generate preview content
    const selectedComponents = [];
    document.querySelectorAll('.component-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
        selectedComponents.push(checkbox.value);
    });
    
    const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
    const scheduledTime = document.getElementById('scheduledTime').value;
    const maintenanceWindow = document.getElementById('maintenanceWindow').value;
    
    content.innerHTML = `
        <div class="row">
            <div class="col-12">
                <h6>Update Summary</h6>
                <ul>
                    <li><strong>Servers:</strong> ${selectedServers.size} selected</li>
                    <li><strong>Components:</strong> ${selectedComponents.join(', ')}</li>
                    <li><strong>Schedule:</strong> ${scheduleType === 'immediate' ? 'Start immediately' : 'Start at ' + new Date(scheduledTime).toLocaleString()}</li>
                    <li><strong>Maintenance Window:</strong> ${document.getElementById('maintenanceWindowSummary').textContent}</li>
                    <li><strong>Estimated Total Time:</strong> ${Math.ceil(selectedServers.size * 45 / 60)} hours</li>
                </ul>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Selected Servers</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Server</th>
                                <th>Updates Available</th>
                                <th>Estimated Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Array.from(selectedServers).map(serverId => {
                                const serverElement = document.querySelector(`[data-server-id="${serverId}"]`);
                                const serverName = serverElement.querySelector('strong').textContent;
                                const hasUpdates = serverElement.querySelector('.badge.bg-warning') ? 'Yes' : 'No';
                                return `
                                    <tr>
                                        <td>${serverName}</td>
                                        <td>${hasUpdates}</td>
                                        <td>~45 minutes</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    modal.show();
}

function confirmSchedule() {
    // Close preview modal
    bootstrap.Modal.getInstance(document.getElementById('previewModal')).hide();
    
    // Submit the form
    document.getElementById('scheduleForm').dispatchEvent(new Event('submit'));
}

function handleFormSubmit(event) {
    event.preventDefault();
    
    if (selectedServers.size === 0) {
        alert('Please select at least one server.');
        return;
    }
    
    // Collect form data
    const selectedComponents = [];
    document.querySelectorAll('.component-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
        selectedComponents.push(checkbox.value);
    });
    
    if (selectedComponents.length === 0) {
        alert('Please select at least one component to update.');
        return;
    }
    
    const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
    const scheduledTime = scheduleType === 'scheduled' ? document.getElementById('scheduledTime').value : null;
    const maintenanceWindow = parseInt(document.getElementById('maintenanceWindow').value);
    const rollbackEnabled = document.getElementById('rollbackEnabled').checked;
    
    // Prepare data for API
    const updateData = {
        server_ids: Array.from(selectedServers),
        components: selectedComponents,
        scheduled_time: scheduledTime,
        maintenance_window: maintenanceWindow,
        rollback_enabled: rollbackEnabled,
        pre_validation: document.getElementById('preValidation').checked,
        post_validation: document.getElementById('postValidation').checked,
        notify_on_completion: document.getElementById('notifyOnCompletion').checked
    };
    
    // Show loading state
    const scheduleButton = document.getElementById('scheduleButton');
    const originalText = scheduleButton.innerHTML;
    scheduleButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...';
    scheduleButton.disabled = true;
    
    // Submit to API
    fetch('{{ url_for("firmware.api_schedule_firmware_update") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully scheduled firmware updates for ${data.total_scheduled} servers!`);
            window.location.href = '{{ url_for("firmware.firmware_dashboard") }}';
        } else {
            alert(`Error scheduling updates: ${data.error}`);
            scheduleButton.innerHTML = originalText;
            scheduleButton.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error scheduling firmware updates. Please try again.');
        scheduleButton.innerHTML = originalText;
        scheduleButton.disabled = false;
    });
}

function saveTemplate() {
    alert('Save template functionality will be implemented in a future version.');
}

function loadTemplate() {
    alert('Load template functionality will be implemented in a future version.');
}
</script>
{% endblock %}
