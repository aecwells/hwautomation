<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management - HWAutomation</title>
    
    <!-- Theme detection script (must be first) -->
    <script>
        (function() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const storedTheme = localStorage.getItem('theme');
            const theme = storedTheme || (prefersDark ? 'dark' : 'light');
            
            document.documentElement.setAttribute('data-bs-theme', theme);
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    document.documentElement.setAttribute('data-bs-theme', e.matches ? 'dark' : 'light');
                }
            });
        })();
    </script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .status-indicator.online { background-color: #28a745; }
        .status-indicator.offline { background-color: #dc3545; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .theme-toggle { border: none; background: none; color: inherit; }
        .theme-toggle:hover { background-color: rgba(0,0,0,0.1); }
        [data-bs-theme="dark"] .theme-toggle:hover { background-color: rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-database"></i> HWAutomation - Database Management
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row">
                <a class="nav-link me-3" href="/">
                    <i class="bi bi-house-door"></i> Dashboard
                </a>
                <button class="btn theme-toggle btn-sm" id="themeToggle" onclick="toggleTheme()" 
                        title="Toggle light/dark theme">
                    <i class="bi bi-sun-fill" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <!-- Database Overview -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle"></i> Database Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-indicator online me-2"></span>
                            <strong>Status:</strong> 
                            <span class="ms-2 text-success">Connected</span>
                        </div>
                        <div class="mb-2">
                            <strong>Type:</strong> <span class="ms-2">SQLite</span>
                        </div>
                        <div class="mb-2">
                            <strong>Version:</strong> <span class="ms-2" id="db-version">-</span>
                        </div>
                        <div class="mb-2">
                            <strong>Size:</strong> <span class="ms-2" id="db-size">-</span>
                        </div>
                        <div class="mb-2">
                            <strong>Path:</strong> 
                            <small class="ms-2 text-muted" id="db-path">-</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart"></i> Database Statistics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-item">
                                    <h4 class="mb-1" id="total-servers">0</h4>
                                    <small class="text-muted">Servers</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-item">
                                    <h4 class="mb-1" id="total-tables">0</h4>
                                    <small class="text-muted">Tables</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear"></i> Database Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshDatabaseInfo()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Info
                            </button>
                            <button class="btn btn-outline-info" onclick="exportDatabase()">
                                <i class="bi bi-download"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Tables -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-table"></i> Database Tables
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="tables-container">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading database tables...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Theme support functions
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = theme === 'dark' ? 'bi bi-moon-fill' : 'bi bi-sun-fill';
            }
        }

        // Database management functions
        async function refreshDatabaseInfo() {
            try {
                const response = await fetch('/api/database/info');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('db-version').textContent = data.info.version;
                    document.getElementById('db-size').textContent = data.info.size;
                    document.getElementById('db-path').textContent = data.info.path || 'In-memory';
                    document.getElementById('total-servers').textContent = data.info.server_count;
                    document.getElementById('total-tables').textContent = data.info.table_count;
                }
            } catch (error) {
                console.error('Error refreshing database info:', error);
            }
        }

        async function loadDatabaseTables() {
            try {
                const response = await fetch('/api/database/tables');
                const data = await response.json();
                
                if (data.success) {
                    displayTables(data.tables);
                }
            } catch (error) {
                console.error('Error loading database tables:', error);
                document.getElementById('tables-container').innerHTML = 
                    '<div class="text-danger">Error loading tables: ' + error.message + '</div>';
            }
        }

        function displayTables(tables) {
            const container = document.getElementById('tables-container');
            let html = '';

            for (const [tableName, tableInfo] of Object.entries(tables)) {
                html += `
                    <div class="mb-4">
                        <h6 class="fw-bold">
                            <i class="bi bi-table"></i> ${tableName} 
                            <span class="badge bg-secondary">${tableInfo.count} records</span>
                            ${tableInfo.count > 100 ? `<small class="text-muted">(showing first ${tableInfo.showing})</small>` : ''}
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                `;

                if (tableInfo.data.length > 0) {
                    // Table headers
                    const headers = Object.keys(tableInfo.data[0]);
                    html += '<thead><tr>';
                    headers.forEach(header => {
                        html += `<th>${header}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    // Table rows
                    tableInfo.data.forEach(row => {
                        html += '<tr>';
                        headers.forEach(header => {
                            let value = row[header];
                            if (value === null) value = '<em class="text-muted">null</em>';
                            else if (typeof value === 'string' && value.length > 50) {
                                value = value.substring(0, 50) + '...';
                            }
                            html += `<td>${value}</td>`;
                        });
                        html += '</tr>';
                    });

                    html += '</tbody>';
                } else {
                    html += '<tbody><tr><td colspan="100%" class="text-center text-muted">No data in this table</td></tr></tbody>';
                }

                html += '</table></div></div>';
            }

            if (Object.keys(tables).length === 0) {
                html = '<div class="text-center text-muted">No tables found in database</div>';
            }

            container.innerHTML = html;
        }

        function exportDatabase() {
            window.open('/api/database/tables?format=json', '_blank');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set theme icon
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            updateThemeIcon(currentTheme);
            
            // Load database info and tables
            refreshDatabaseInfo();
            loadDatabaseTables();
        });
    </script>
</body>
</html>
