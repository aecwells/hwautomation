{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .firmware-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }

    .firmware-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .update-available {
        border-left-color: #ffc107;
    }

    .up-to-date {
        border-left-color: #28a745;
    }

    .status-unknown {
        border-left-color: #6c757d;
    }

    .firmware-status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .progress-ring {
        width: 60px;
        height: 60px;
    }

    .progress-ring circle {
        fill: transparent;
        stroke: #007bff;
        stroke-width: 4;
        stroke-dasharray: 188.5;
        stroke-dashoffset: 188.5;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dashoffset 0.3s ease;
    }

    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
    }

    .metric-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Firmware Management Dashboard</h1>
                    <p class="text-muted">Monitor and manage firmware across your infrastructure</p>
                </div>
                <div>
                    <button class="btn btn-primary me-2" onclick="refreshInventory()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-success" onclick="showScheduleModal()">
                        <i class="fas fa-calendar-plus"></i> Schedule Updates
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card bg-primary">
                <div class="metric-number">{{ inventory.update_summary.total_servers }}</div>
                <div class="metric-label">Total Servers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card bg-warning">
                <div class="metric-number">{{ inventory.update_summary.updates_available }}</div>
                <div class="metric-label">Updates Available</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card bg-success">
                <div class="metric-number">{{ inventory.update_summary.up_to_date }}</div>
                <div class="metric-label">Up to Date</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card bg-secondary">
                <div class="metric-number">{{ inventory.update_summary.unknown_status }}</div>
                <div class="metric-label">Unknown Status</div>
            </div>
        </div>
    </div>

    <!-- Firmware Repository Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-database"></i> Firmware Repository Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Total Firmware Files:</strong> {{ inventory.firmware_repository.total_files }}</p>
                            <p><strong>Supported Vendors:</strong>
                                {% for vendor in inventory.firmware_repository.vendors %}
                                    <span class="badge bg-secondary me-1">{{ vendor.upper() }}</span>
                                {% endfor %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <div class="text-end">
                                <button class="btn btn-outline-primary" onclick="showDetailedInventory()">
                                    <i class="fas fa-list"></i> View Detailed Inventory
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Types & Motherboard Firmware -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-microchip"></i> Device Types & Motherboard Firmware
                    </h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="vendorFilter" id="allVendors" value="all" checked>
                        <label class="btn btn-outline-secondary btn-sm" for="allVendors">All Vendors</label>

                        <input type="radio" class="btn-check" name="vendorFilter" id="supermicro" value="supermicro">
                        <label class="btn btn-outline-primary btn-sm" for="supermicro">Supermicro</label>

                        <input type="radio" class="btn-check" name="vendorFilter" id="hpe" value="hpe">
                        <label class="btn btn-outline-info btn-sm" for="hpe">HPE</label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="deviceTypesGrid" class="row">
                        <!-- Device types will be loaded here via JavaScript -->
                        <div class="col-12 text-center py-4" id="deviceTypesLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading device types...</span>
                            </div>
                            <p class="text-muted mt-2">Loading device types and firmware information...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Firmware Status -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-server"></i> Server Firmware Status
                    </h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="statusFilter" id="all" value="all" checked>
                        <label class="btn btn-outline-secondary btn-sm" for="all">All</label>

                        <input type="radio" class="btn-check" name="statusFilter" id="updates" value="updates">
                        <label class="btn btn-outline-warning btn-sm" for="updates">Updates Available</label>

                        <input type="radio" class="btn-check" name="statusFilter" id="current" value="current">
                        <label class="btn btn-outline-success btn-sm" for="current">Up to Date</label>
                    </div>
                </div>
                <div class="card-body">
                    {% if inventory.servers %}
                    <div class="row" id="serverGrid">
                        {% for server in inventory.servers %}
                        <div class="col-lg-4 col-md-6 mb-3 server-card"
                             data-status="{{ 'updates' if server.updates_available else ('current' if server.firmware_status == 'detected' else 'unknown') }}">
                            <div class="card firmware-card {{ 'update-available' if server.updates_available else ('up-to-date' if server.firmware_status == 'detected' else 'status-unknown') }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">{{ server.hostname }}</h6>
                                        {% if server.updates_available %}
                                            <span class="badge bg-warning firmware-status-badge">Updates Available</span>
                                        {% elif server.firmware_status == 'detected' %}
                                            <span class="badge bg-success firmware-status-badge">Up to Date</span>
                                        {% else %}
                                            <span class="badge bg-secondary firmware-status-badge">Unknown</span>
                                        {% endif %}
                                    </div>

                                    <p class="text-muted small mb-2">
                                        ID: {{ server.id }} | Type: {{ server.device_type or 'Unknown' }}
                                    </p>

                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">BIOS</small>
                                            <div class="fw-bold">{{ server.bios_version }}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">BMC</small>
                                            <div class="fw-bold">{{ server.bmc_version }}</div>
                                        </div>
                                    </div>

                                    {% if server.updates_available and server.available_updates %}
                                    <div class="mt-2">
                                        <small class="text-muted">Available Updates:</small>
                                        {% for update in server.available_updates %}
                                        <div class="small">
                                            <span class="badge bg-light text-dark">{{ update.component }}</span>
                                            {{ update.current }} → {{ update.available }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <div class="mt-3 d-flex justify-content-between">
                                        {% if server.updates_available %}
                                        <button class="btn btn-sm btn-warning" onclick="scheduleServerUpdate('{{ server.id }}')">
                                            <i class="fas fa-download"></i> Update
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('{{ server.id }}')">
                                            <i class="fas fa-info-circle"></i> Details
                                        </button>
                                    </div>

                                    {% if server.last_checked %}
                                    <small class="text-muted d-block mt-2">
                                        Last checked: {{ moment(server.last_checked).fromNow() }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-server fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No servers found</h5>
                        <p class="text-muted">Add servers to your infrastructure to view firmware status</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Server Details Modal -->
<div class="modal fade" id="serverDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Server Firmware Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="serverDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Schedule Update Modal -->
<div class="modal fade" id="scheduleUpdateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Firmware Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleUpdateForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Server Selection</h6>
                            <div id="serverSelection" class="mb-3">
                                <!-- Server selection will be populated here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Update Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">Schedule Type</label>
                                <select class="form-select" id="scheduleType">
                                    <option value="immediate">Immediate</option>
                                    <option value="scheduled">Scheduled</option>
                                </select>
                            </div>
                            <div class="mb-3" id="scheduleTimeGroup" style="display: none;">
                                <label class="form-label">Scheduled Time</label>
                                <input type="datetime-local" class="form-control" id="scheduleTime">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Components to Update</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="updateBios" checked>
                                    <label class="form-check-label" for="updateBios">BIOS</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="updateBmc" checked>
                                    <label class="form-check-label" for="updateBmc">BMC</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitScheduleUpdate()">Schedule Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Inventory Modal -->
<div class="modal fade" id="detailedInventoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detailed Firmware Inventory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Filter servers..." id="inventoryFilter">
                            <button class="btn btn-outline-secondary" onclick="filterInventory()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-success" onclick="exportInventory()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Server ID</th>
                                <th>Hostname</th>
                                <th>Device Type</th>
                                <th>BIOS Version</th>
                                <th>BMC Version</th>
                                <th>Status</th>
                                <th>Last Checked</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Type Details Modal -->
<div class="modal fade" id="deviceTypeDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Device Type Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deviceTypeDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshInventory() {
    // Show loading state
    const refreshBtn = document.querySelector('button[onclick="refreshInventory()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;

    // Reload the page to get fresh data
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function filterServers() {
    const selectedFilter = document.querySelector('input[name="statusFilter"]:checked').value;
    const serverCards = document.querySelectorAll('.server-card');

    serverCards.forEach(card => {
        const status = card.getAttribute('data-status');
        if (selectedFilter === 'all' || status === selectedFilter) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function scheduleServerUpdate(serverId) {
    // Show schedule modal with pre-selected server
    showScheduleModal(serverId);
}

function showScheduleModal(preSelectedServerId = null) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleUpdateModal'));

    // Populate server selection
    const serverSelection = document.getElementById('serverSelection');
    serverSelection.innerHTML = '';

    // Add servers with available updates from template data
    {% if inventory.servers %}
    const serversData = [
        {% for server in inventory.servers %}
        {
            id: '{{ server.id }}',
            hostname: '{{ server.hostname }}',
            updates_available: {{ server.updates_available | lower }},
            available_updates: [
                {% if server.available_updates %}
                {% for update in server.available_updates %}
                {
                    component: '{{ update.component }}',
                    current: '{{ update.current }}',
                    available: '{{ update.available }}'
                }{% if not loop.last %},{% endif %}
                {% endfor %}
                {% endif %}
            ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    {% else %}
    const serversData = [];
    {% endif %}

    serversData.forEach(server => {
        if (server.updates_available) {
            const isSelected = preSelectedServerId === server.id;
            const updatesText = server.available_updates.map(u => `${u.component}: ${u.current} → ${u.available}`).join(', ');
            serverSelection.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${server.id}" id="server_${server.id}" ${isSelected ? 'checked' : ''}>
                    <label class="form-check-label" for="server_${server.id}">
                        ${server.hostname} (${server.id})
                        <small class="text-muted d-block">${updatesText}</small>
                    </label>
                </div>
            `;
        }
    });

    modal.show();
}

function showDetailedInventory() {
    console.log('showDetailedInventory called, bootstrap type:', typeof bootstrap);
    const modal = new bootstrap.Modal(document.getElementById('detailedInventoryModal'));

    // Populate inventory table
    const tableBody = document.getElementById('inventoryTableBody');
    tableBody.innerHTML = '';

    {% if inventory.servers %}
    const inventoryData = [
        {% for server in inventory.servers %}
        {
            id: '{{ server.id }}',
            hostname: '{{ server.hostname }}',
            device_type: '{{ server.device_type or "Unknown" }}',
            bios_version: '{{ server.bios_version }}',
            bmc_version: '{{ server.bmc_version }}',
            updates_available: {{ server.updates_available | lower }},
            firmware_status: '{{ server.firmware_status }}',
            last_checked: '{{ server.last_checked or "" }}'
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    {% else %}
    const inventoryData = [];
    {% endif %}

    inventoryData.forEach(server => {
        let statusBadge;
        if (server.updates_available) {
            statusBadge = '<span class="badge bg-warning">Updates Available</span>';
        } else if (server.firmware_status === 'detected') {
            statusBadge = '<span class="badge bg-success">Up to Date</span>';
        } else {
            statusBadge = '<span class="badge bg-secondary">Unknown</span>';
        }

        const lastChecked = server.last_checked ?
            moment(server.last_checked).fromNow() : 'Never';

        const updateButton = server.updates_available ?
            `<button class="btn btn-outline-warning" onclick="scheduleServerUpdate('${server.id}')">Update</button>` : '';

        tableBody.innerHTML += `
            <tr>
                <td>${server.id}</td>
                <td>${server.hostname}</td>
                <td>${server.device_type}</td>
                <td><code class="small">${server.bios_version}</code></td>
                <td><code class="small">${server.bmc_version}</code></td>
                <td>${statusBadge}</td>
                <td class="small">${lastChecked}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewDetails('${server.id}')">Details</button>
                        ${updateButton}
                    </div>
                </td>
            </tr>
        `;
    });

    modal.show();
}

function submitScheduleUpdate() {
    const selectedServers = Array.from(document.querySelectorAll('#serverSelection input:checked')).map(cb => cb.value);
    const scheduleType = document.getElementById('scheduleType').value;
    const scheduleTime = document.getElementById('scheduleTime').value;
    const updateBios = document.getElementById('updateBios').checked;
    const updateBmc = document.getElementById('updateBmc').checked;

    if (selectedServers.length === 0) {
        alert('Please select at least one server to update');
        return;
    }

    const updateData = {
        servers: selectedServers,
        schedule_type: scheduleType,
        schedule_time: scheduleTime,
        components: {
            bios: updateBios,
            bmc: updateBmc
        }
    };

    // Simulate scheduling (replace with actual API call)
    console.log('Scheduling update:', updateData);
    alert(`Update scheduled for ${selectedServers.length} server(s)`);

    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('scheduleUpdateModal')).hide();
}

function filterInventory() {
    const filter = document.getElementById('inventoryFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#inventoryTable tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
}

function exportInventory() {
    // Simulate CSV export
    alert('Exporting inventory to CSV...');
}

function scheduleUpdate(serverId) {
    // Legacy function, now calls scheduleServerUpdate
    scheduleServerUpdate(serverId);
}

function viewDetails(serverId) {
    // Load server details in modal
    const modal = new bootstrap.Modal(document.getElementById('serverDetailsModal'));
    const content = document.getElementById('serverDetailsContent');

    content.innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Loading server details...</p>
        </div>
    `;

    modal.show();

    // Simulate loading server details
    setTimeout(() => {
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Server Information</h6>
                    <p><strong>Server ID:</strong> ${serverId}</p>
                    <p><strong>Status:</strong> Ready</p>
                    <p><strong>Device Type:</strong> a1.c5.large</p>
                </div>
                <div class="col-md-6">
                    <h6>Current Firmware</h6>
                    <p><strong>BIOS Version:</strong> Simulated-v1.0</p>
                    <p><strong>BMC Version:</strong> Simulated-BMC-v2.0</p>
                    <p><strong>Last Updated:</strong> 2 weeks ago</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <h6>Firmware History</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Component</th>
                                    <th>Version</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024-07-20</td>
                                    <td>BIOS</td>
                                    <td>v1.0</td>
                                    <td><span class="badge bg-success">Success</span></td>
                                </tr>
                                <tr>
                                    <td>2024-07-15</td>
                                    <td>BMC</td>
                                    <td>v2.0</td>
                                    <td><span class="badge bg-success">Success</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }, 1000);
}

// Device Types Functions
async function loadDeviceTypes() {
    try {
        const response = await fetch('/firmware/api/device-types');
        const data = await response.json();

        if (data.device_types) {
            renderDeviceTypes(data.device_types);
        } else {
            showDeviceTypesError('Failed to load device types');
        }
    } catch (error) {
        console.error('Error loading device types:', error);
        showDeviceTypesError('Error loading device types');
    }
}

function renderDeviceTypes(deviceTypes) {
    const grid = document.getElementById('deviceTypesGrid');

    if (deviceTypes.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center py-4">
                <i class="fas fa-microchip fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No device types found</h5>
                <p class="text-muted">No motherboard configurations available</p>
            </div>
        `;
        return;
    }

    grid.innerHTML = deviceTypes.map(device => `
        <div class="col-lg-4 col-md-6 mb-3 device-type-card" data-vendor="${device.vendor.toLowerCase()}">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-microchip text-primary"></i>
                        ${device.device_type}
                    </h6>
                    <span class="badge bg-primary">${device.vendor}</span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <p class="text-muted small mb-2">${device.description}</p>
                            <p class="mb-1"><strong>Motherboard:</strong> ${device.motherboard}</p>
                            <p class="mb-1"><strong>CPU:</strong> ${device.cpu_name} (${device.cpu_cores} cores)</p>
                            <p class="mb-1"><strong>RAM:</strong> ${device.ram_gb}GB</p>
                        </div>
                    </div>

                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <small class="text-muted">BIOS Version</small>
                            <div class="fw-bold text-primary">${device.bios_version}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">BMC Version</small>
                            <div class="fw-bold text-success">${device.bmc_version}</div>
                        </div>
                    </div>

                    ${device.firmware_files.length > 0 ? `
                        <div class="mb-3">
                            <small class="text-muted">Available Firmware Files:</small>
                            <div class="mt-1">
                                ${device.firmware_files.map(file => `
                                    <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-light rounded">
                                        <div class="flex-grow-1">
                                            <small>
                                                <span class="badge bg-secondary me-1">${file.type}</span>
                                                ${file.filename}
                                                <span class="text-muted">(${file.size})</span>
                                            </small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="downloadFirmware('${file.download_url}', '${file.filename}')"
                                                title="Download ${file.filename}">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-2">
                            <small class="text-muted">No firmware files available</small>
                        </div>
                    `}

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Updated: ${device.last_updated}</small>
                        <button class="btn btn-sm btn-outline-info"
                                onclick="viewDeviceTypeDetails('${device.device_type}', '${device.motherboard}')">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showDeviceTypesError(message) {
    const grid = document.getElementById('deviceTypesGrid');
    grid.innerHTML = `
        <div class="col-12 text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h5 class="text-warning">Error Loading Device Types</h5>
            <p class="text-muted">${message}</p>
            <button class="btn btn-primary" onclick="loadDeviceTypes()">
                <i class="fas fa-sync-alt"></i> Retry
            </button>
        </div>
    `;
}

function filterDeviceTypes() {
    const selectedVendor = document.querySelector('input[name="vendorFilter"]:checked').value;
    const deviceCards = document.querySelectorAll('.device-type-card');

    deviceCards.forEach(card => {
        const vendor = card.getAttribute('data-vendor');
        if (selectedVendor === 'all' || vendor === selectedVendor) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

async function downloadFirmware(downloadUrl, filename) {
    try {
        // Create a temporary anchor element to trigger download
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Show success message
        showToast(`Downloading ${filename}...`, 'success');
    } catch (error) {
        console.error('Error downloading firmware:', error);
        showToast('Failed to download firmware file', 'error');
    }
}

function viewDeviceTypeDetails(deviceType, motherboard) {
    // Create and show device type details modal
    const modal = new bootstrap.Modal(document.getElementById('deviceTypeDetailsModal'));
    const content = document.getElementById('deviceTypeDetailsContent');

    content.innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Loading device type details...</p>
        </div>
    `;

    modal.show();

    // Simulate loading detailed information
    setTimeout(() => {
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Device Information</h6>
                    <p><strong>Device Type:</strong> ${deviceType}</p>
                    <p><strong>Motherboard:</strong> ${motherboard}</p>
                    <p><strong>Status:</strong> Available</p>
                </div>
                <div class="col-md-6">
                    <h6>Compatibility</h6>
                    <p><strong>Servers Using:</strong> <span class="badge bg-primary">3</span></p>
                    <p><strong>Last Firmware Update:</strong> 2 weeks ago</p>
                    <p><strong>Firmware Repository:</strong> Available</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <h6>Recent Firmware Activity</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Action</th>
                                    <th>Version</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024-07-25</td>
                                    <td>BIOS Upload</td>
                                    <td>v3.7</td>
                                    <td><span class="badge bg-success">Available</span></td>
                                </tr>
                                <tr>
                                    <td>2024-07-20</td>
                                    <td>BMC Upload</td>
                                    <td>v1.73.14</td>
                                    <td><span class="badge bg-success">Available</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }, 1000);
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastId = 'toast-' + Date.now();

    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : (type === 'success' ? 'success' : 'primary')} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1050';
    document.body.appendChild(container);
    return container;
}

// Set up event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Filter event listeners
    document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
        radio.addEventListener('change', filterServers);
    });

    // Device type vendor filter event listeners
    document.querySelectorAll('input[name="vendorFilter"]').forEach(radio => {
        radio.addEventListener('change', filterDeviceTypes);
    });

    // Load device types on page load
    loadDeviceTypes();

    // Schedule type change handler
    const scheduleTypeSelect = document.getElementById('scheduleType');
    if (scheduleTypeSelect) {
        scheduleTypeSelect.addEventListener('change', function() {
            const timeGroup = document.getElementById('scheduleTimeGroup');
            timeGroup.style.display = this.value === 'scheduled' ? 'block' : 'none';
        });
    }

    // Auto-refresh every 30 seconds
    setInterval(() => {
        // Only refresh if no modals are open
        if (!document.querySelector('.modal.show')) {
            refreshInventory();
            // Also refresh device types
            loadDeviceTypes();
        }
    }, 30000);
});

// Debug: Check if Bootstrap is available
document.addEventListener('DOMContentLoaded', function() {
    console.log('Bootstrap availability check:');
    console.log('typeof bootstrap:', typeof bootstrap);
    console.log('bootstrap.Modal:', typeof bootstrap?.Modal);

    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not available! This will cause modal errors.');
    } else {
        console.log('✅ Bootstrap is available globally');
    }
});
</script>
{% endblock %}
