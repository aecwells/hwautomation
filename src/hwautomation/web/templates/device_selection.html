{% extends "base.html" %}

{% block title %}Device Selection - HW Automation{% endblock %}

{% block extra_head %}
<!-- Masonry layout library -->
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
<style>
    /* Theme-aware CSS custom properties for device selection */
    :root[data-bs-theme="light"] {
        --device-card-bg: #ffffff;
        --device-card-border: #dee2e6;
        --device-card-hover-border: #0d6efd;
        --device-text-primary: #212529;
        --device-text-secondary: #6c757d;
        --device-text-muted: #6c757d;
        --device-hover-bg: #e9ecef;
        --device-shadow: rgba(0,0,0,0.1);
        --device-table-hover: rgba(0,0,0,0.075);
        --device-progress-bg: rgba(255, 193, 7, 0.2);
    }
    
    :root[data-bs-theme="dark"] {
        --device-card-bg: #343a40;
        --device-card-border: #495057;
        --device-card-hover-border: #0d6efd;
        --device-text-primary: #dee2e6;
        --device-text-secondary: #adb5bd;
        --device-text-muted: #6c757d;
        --device-hover-bg: #495057;
        --device-shadow: rgba(0,0,0,0.3);
        --device-table-hover: rgba(255,255,255,0.075);
        --device-progress-bg: rgba(255, 193, 7, 0.3);
    }

    .device-card {
        transition: transform 0.2s, box-shadow 0.2s;
        margin-bottom: 1rem;
        background-color: var(--device-card-bg);
        border-color: var(--device-card-border);
        color: var(--device-text-primary);
    }
    
    .device-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--device-shadow);
        border-color: var(--device-card-hover-border);
    }
    
    .gap-3 {
        gap: 1rem !important;
    }
    
    .badge.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    #device-cards-container .col-lg-4 {
        margin-bottom: 1rem;
    }
    
    .table th {
        border-top: none;
        font-weight: 600;
        color: var(--device-text-primary);
    }
    
    .table td {
        color: var(--device-text-primary);
    }
    
    .table-hover tbody tr:hover {
        background-color: var(--device-table-hover);
    }
    
    .status-badge {
        font-size: 0.875rem;
    }
    
    /* Commissioning progress styling with theme support */
    .commissioning-progress {
        animation: pulse-fade 2s infinite;
    }
    
    .commissioning-progress .progress {
        background-color: var(--device-progress-bg);
    }
    
    .commissioning-progress .progress-bar {
        transition: width 0.5s ease;
    }
    
    @keyframes pulse-fade {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* Better spacing for progress in list view */
    .commissioning-progress small {
        font-size: 0.75rem;
        line-height: 1.2;
        color: var(--device-text-secondary);
    }
    
    /* Disabled commission button styling */
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* Form controls theme support */
    .form-control, .form-select {
        background-color: var(--bs-body-bg);
        border-color: var(--device-card-border);
        color: var(--device-text-primary);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Modal theme support */
    .modal-content {
        background-color: var(--device-card-bg);
        color: var(--device-text-primary);
    }
    
    .modal-header {
        border-bottom-color: var(--device-card-border);
    }
    
    .modal-footer {
        border-top-color: var(--device-card-border);
    }
    
    /* Alert theme support */
    .alert-info {
        background-color: var(--bs-info-bg-subtle);
        border-color: var(--bs-info-border-subtle);
        color: var(--bs-info-text-emphasis);
    }
    
    /* Text color overrides for theme consistency */
    .text-muted {
        color: var(--device-text-muted) !important;
    }
    
    .form-text {
        color: var(--device-text-secondary) !important;
    }
    
    .form-control-plaintext {
        color: var(--device-text-primary) !important;
    }
    
    /* Card body text color */
    .card-body p, .card-body small {
        color: var(--device-text-secondary);
    }
    
    /* Enhanced empty state styling */
    #no-devices {
        color: var(--device-text-muted);
    }
    
    #no-devices .display-4 {
        color: var(--device-text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>Device Selection for Commissioning</h2>
            <p class="text-muted">Select MaaS devices for commissioning without manually entering Machine IDs</p>
        </div>
    </div>

    <!-- Device Status Summary -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Device Status Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="status-summary">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary" id="total-count">-</h4>
                                <p>Total Devices</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success" id="available-count">-</h4>
                                <p>Available</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning" id="commissioned-count">-</h4>
                                <p>Commissioned</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info" id="deployed-count">-</h4>
                                <p>Deployed</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Search & Filter Devices</h5>
                </div>
                <div class="card-body">
                    <form id="device-filter-form">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="hostname-search">Hostname</label>
                                <input type="text" class="form-control" id="hostname-search" placeholder="Search by hostname">
                            </div>
                            <div class="col-md-2">
                                <label for="status-filter">Status</label>
                                <select class="form-control" id="status-filter">
                                    <option value="">All Statuses</option>
                                    <option value="available">Available</option>
                                    <option value="commissioned">Commissioned</option>
                                    <option value="deployed">Deployed</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="min-cpu">Min CPU Cores</label>
                                <input type="number" class="form-control" id="min-cpu" min="1" placeholder="e.g., 8">
                            </div>
                            <div class="col-md-2">
                                <label for="min-memory">Min Memory (GB)</label>
                                <input type="number" class="form-control" id="min-memory" min="1" placeholder="e.g., 16">
                            </div>
                            <div class="col-md-2">
                                <label for="architecture">Architecture</label>
                                <select class="form-control" id="architecture">
                                    <option value="">Any</option>
                                    <option value="amd64/generic">amd64/generic</option>
                                    <option value="arm64/generic">arm64/generic</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary form-control">Search</button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-secondary btn-sm" id="clear-filters">Clear Filters</button>
                                <button type="button" class="btn btn-info btn-sm" id="refresh-devices">Refresh</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Device List -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Available Devices</h5>
                    <div class="d-flex align-items-center gap-3">
                        <!-- View Toggle Buttons -->
                        <div class="btn-group" role="group" aria-label="View toggle">
                            <button type="button" class="btn btn-outline-secondary btn-sm active" id="card-view-btn" onclick="switchToCardView()">
                                <i class="bi bi-grid-3x3-gap"></i> Cards
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="list-view-btn" onclick="switchToListView()">
                                <i class="bi bi-list-ul"></i> List
                            </button>
                        </div>
                        <span id="device-count" class="badge bg-secondary">0 devices</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="device-loading" class="text-center" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading devices...</p>
                    </div>
                    
                    <!-- Card/Masonry View -->
                    <div id="device-cards-container" class="row" data-masonry='{"percentPosition": true}'>
                        <!-- Device cards will be populated here -->
                    </div>
                    
                    <!-- List View -->
                    <div id="device-list-container" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Device</th>
                                        <th>Status</th>
                                        <th>CPU</th>
                                        <th>Memory</th>
                                        <th>Storage</th>
                                        <th>IP Address</th>
                                        <th>Architecture</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="device-list-tbody">
                                    <!-- Device rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="no-devices" class="text-center text-muted" style="display: none;">
                        <i class="bi bi-inbox display-4"></i>
                        <p class="mt-2">No devices found matching your criteria.</p>
                        <button type="button" class="btn btn-outline-primary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Details Modal -->
<div class="modal fade" id="deviceDetailsModal" tabindex="-1" aria-labelledby="deviceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deviceDetailsModalLabel">Device Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="device-details-content">
                    <!-- Device details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="commission-device" style="display: none;">
                    Commission Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Commission Device Modal -->
<div class="modal fade" id="commissionModal" tabindex="-1" aria-labelledby="commissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commissionModalLabel">Commission Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="commission-form">
                    <input type="hidden" id="commission-system-id" name="system_id">
                    <div class="form-group">
                        <label>Device</label>
                        <p id="commission-device-info" class="form-control-plaintext"></p>
                    </div>
                    <div class="form-group">
                        <label for="commission-device-type">Device Type *</label>
                        <select class="form-control" id="commission-device-type" name="device_type" required>
                            <option value="">Select device type...</option>
                            <option value="s2.c2.small">s2.c2.small (Basic)</option>
                            <option value="s2.c2.medium">s2.c2.medium (Standard)</option>
                            <option value="s2.c2.large">s2.c2.large (High Performance)</option>
                        </select>
                        <small class="form-text text-muted">Suggested: <span id="suggested-device-type">-</span></small>
                    </div>
                    <div class="form-group">
                        <label for="commission-ipmi-ip">Target IPMI IP (Optional)</label>
                        <input type="text" class="form-control" id="commission-ipmi-ip" name="target_ipmi_ip" placeholder="e.g., 192.168.100.10">
                        <small class="form-text text-muted">Leave blank to configure manually after commissioning</small>
                    </div>
                    <div class="form-group">
                        <label for="commission-rack-location">Rack Location (Optional)</label>
                        <input type="text" class="form-control" id="commission-rack-location" name="rack_location" placeholder="e.g., Rack-A-01">
                        <small class="form-text text-muted">Can be set later during manual IPMI configuration</small>
                    </div>
                </form>
                <div id="commission-status" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Commissioning in progress...</strong>
                        <div class="progress mt-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="commission-progress"></div>
                        </div>
                        <div id="commission-step" class="mt-2">Initializing...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="commission-form" class="btn btn-primary" id="start-commission">
                    Start Commissioning
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/device-selection.js') }}"></script>
{% endblock %}
