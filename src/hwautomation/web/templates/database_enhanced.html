<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HWAutomation - Database Management</title>
    
    <!-- Theme detection script (must be first) -->
    <script>
        (function() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const storedTheme = localStorage.getItem('theme');
            const theme = storedTheme || (prefersDark ? 'dark' : 'light');
            
            document.documentElement.setAttribute('data-bs-theme', theme);
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    document.documentElement.setAttribute('data-bs-theme', e.matches ? 'dark' : 'light');
                }
            });
        })();
    </script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .status-connected { color: #28a745; }
        .status-disconnected { color: #dc3545; }
        .status-working { color: #ffc107; }
        .theme-toggle { border: none; background: none; color: inherit; }
        .theme-toggle:hover { background-color: rgba(0,0,0,0.1); }
        [data-bs-theme="dark"] .theme-toggle:hover { background-color: rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-cpu"></i> HWAutomation - Database Management
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row">
                <a class="nav-link me-3" href="/">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <span class="navbar-text me-3">
                    Database: <span id="db-status" class="status-connected">
                        <i class="bi bi-check-circle"></i>
                        Connected
                    </span>
                </span>
                <button class="btn theme-toggle btn-sm" id="themeToggle" onclick="toggleTheme()" 
                        title="Toggle light/dark theme">
                    <i class="bi bi-sun-fill" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <!-- Database Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-database text-primary fs-1"></i>
                        <h5 class="card-title">Total Servers</h5>
                        <h3 class="text-primary" id="total-servers">0</h3>
                        <small class="text-muted">In database</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-check-circle text-success fs-1"></i>
                        <h5 class="card-title">Ready Servers</h5>
                        <h3 class="text-success" id="ready-servers">0</h3>
                        <small class="text-muted">Available for use</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-gear text-warning fs-1"></i>
                        <h5 class="card-title">Commissioning</h5>
                        <h3 class="text-warning" id="commissioning-servers">0</h3>
                        <small class="text-muted">In progress</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-diagram-3 text-info fs-1"></i>
                        <h5 class="card-title">Schema Version</h5>
                        <h3 class="text-info" id="schema-version">0</h3>
                        <small class="text-muted">Database version</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Management Interface -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-table"></i> Database Tables</h5>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm" id="refreshBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button class="btn btn-outline-success btn-sm" id="exportBtn">
                                    <i class="bi bi-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Table Selection and Search -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select" id="tableSelector" onchange="loadTableData()">
                                    <option value="servers">Servers</option>
                                    <option value="workflow_history">Workflow History</option>
                                    <option value="power_state_history">Power History</option>
                                    <option value="schema_migrations">Schema Migrations</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search...">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="viewMode">
                                    <option value="table">Table View</option>
                                    <option value="cards">Card View</option>
                                </select>
                            </div>
                        </div>

                        <!-- Data Display Area -->
                        <div id="dataContainer">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading database information...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Database management functionality
        let currentData = [];
        let currentTable = 'servers';

        // Load table data
        async function loadTableData() {
            const table = document.getElementById('tableSelector').value;
            currentTable = table;
            
            try {
                const response = await fetch(`/api/database/tables/${table}`);
                const data = await response.json();
                
                if (response.ok) {
                    currentData = data.data || [];
                    displayData(currentData);
                    updateStats(data.stats || {});
                } else {
                    showError(data.error || 'Failed to load data');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        // Display data in table or card format
        function displayData(data) {
            const container = document.getElementById('dataContainer');
            const viewMode = document.getElementById('viewMode').value;
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-inbox fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No data found in ${currentTable} table</p>
                    </div>
                `;
                return;
            }

            if (viewMode === 'table') {
                displayTableView(data, container);
            } else {
                displayCardView(data, container);
            }
        }

        // Display table view
        function displayTableView(data, container) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                ${headers.map(h => `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    const value = row[header];
                    const displayValue = value === null ? '<span class="text-muted">null</span>' : 
                                      typeof value === 'boolean' ? (value ? '✓' : '✗') :
                                      value;
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Display card view
        function displayCardView(data, container) {
            let html = '<div class="row">';
            
            data.forEach((row, index) => {
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">Record ${index + 1}</h6>
                `;
                
                Object.entries(row).forEach(([key, value]) => {
                    const displayValue = value === null ? '<span class="text-muted">null</span>' : 
                                      typeof value === 'boolean' ? (value ? '✓' : '✗') :
                                      value;
                    html += `
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">${key.replace(/_/g, ' ')}:</small>
                            <small><strong>${displayValue}</strong></small>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Update statistics
        function updateStats(stats) {
            document.getElementById('total-servers').textContent = stats.total || currentData.length;
            document.getElementById('ready-servers').textContent = stats.ready || 0;
            document.getElementById('commissioning-servers').textContent = stats.commissioning || 0;
            document.getElementById('schema-version').textContent = stats.schema_version || 'N/A';
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('dataContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Error: ${message}
                </div>
            `;
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadTableData);
        document.getElementById('viewMode').addEventListener('change', () => displayData(currentData));
        document.getElementById('searchInput').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            const filtered = currentData.filter(row => 
                Object.values(row).some(val => 
                    String(val).toLowerCase().includes(term)
                )
            );
            displayData(filtered);
        });

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (currentData.length === 0) return;
            
            const csv = [
                Object.keys(currentData[0]).join(','),
                ...currentData.map(row => Object.values(row).join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTable}_export.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-table"></i> Server Database
                            </h5>
                            <select class="form-select form-select-sm" id="tableSelector" style="width: auto;" onchange="loadTableData()">
                                <option value="servers">Servers</option>
                                <option value="workflow_history">Workflow History</option>
                                <option value="power_state_history">Power History</option>
                                <option value="schema_migrations">Migrations</option>
                            </select>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <!-- View Mode Toggle -->
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="viewMode" id="tableView" autocomplete="off" checked>
                                <label class="btn btn-outline-primary" for="tableView" onclick="switchView('table')">
                                    <i class="bi bi-table"></i> Table
                                </label>
                                <input type="radio" class="btn-check" name="viewMode" id="cardView" autocomplete="off">
                                <label class="btn btn-outline-primary" for="cardView" onclick="switchView('cards')">
                                    <i class="bi bi-grid-3x3-gap"></i> Cards
                                </label>
                            </div>
                            
                            <!-- Column Groups -->
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown">
                                    <i class="bi bi-columns-gap"></i> Columns
                                </button>
                                <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 320px;">
                                    <h6 class="dropdown-header">Show/Hide Column Groups</h6>
                                    <div id="columnGroupControls">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-success btn-sm" onclick="refreshData()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filters -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Search servers..." onkeyup="filterData()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="statusFilter" onchange="filterData()">
                                <option value="">All Status</option>
                                <option value="Ready">Ready</option>
                                <option value="Deployed">Deployed</option>
                                <option value="Commissioning">Commissioning</option>
                                <option value="Failed">Failed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="deviceTypeFilter" onchange="filterData()">
                                <option value="">All Device Types</option>
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="text-muted small">
                                <span id="resultCount">0</span> results
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Table View -->
                    <div id="tableViewContainer">
                        <div class="table-responsive" style="max-height: 70vh;">
                            <table class="table table-sm table-hover mb-0" id="serversTable">
                                <thead class="sticky-top bg-light" id="tableHead">
                                    <!-- Populated by JavaScript -->
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Card View -->
                    <div id="cardViewContainer" style="display: none;">
                        <div class="row g-3 p-3" id="cardContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center p-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading data...</p>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="text-center p-4" style="display: none;">
                        <i class="bi bi-database text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No Data Found</h5>
                        <p class="text-muted">No records match your current filters.</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Define column groups for better organization
const COLUMN_GROUPS = {
    'basic': {
        name: 'Basic Info',
        columns: ['server_id', 'device_type', 'server_type', 'status_name', 'server_model'],
        color: '#0d6efd',
        visible: true
    },
    'network': {
        name: 'Network',
        columns: ['ip_address', 'ip_address_works', 'ipmi_address', 'ipmi_address_works'],
        color: '#198754',
        visible: true
    },
    'workflow': {
        name: 'Workflow',
        columns: ['workflow_status', 'commissioning_status', 'assigned_role', 'deployment_status'],
        color: '#fd7e14',
        visible: true
    },
    'hardware': {
        name: 'Hardware',
        columns: ['cpu_model', 'memory_gb', 'storage_info', 'firmware_version'],
        color: '#6610f2',
        visible: false
    },
    'ipmi': {
        name: 'IPMI/BMC',
        columns: ['ipmi_username', 'ipmi_configured', 'redfish_available', 'power_state'],
        color: '#d63384',
        visible: false
    },
    'config': {
        name: 'Configuration',
        columns: ['bios_config_applied', 'bios_config_version', 'bios_password_set'],
        color: '#20c997',
        visible: false
    },
    'timestamps': {
        name: 'Timestamps',
        columns: ['created_at', 'updated_at', 'last_seen', 'last_workflow_run'],
        color: '#6c757d',
        visible: false
    },
    'metadata': {
        name: 'Metadata',
        columns: ['rack_location', 'tags', 'notes', 'provisioning_target'],
        color: '#fd7e14',
        visible: false
    }
};

let currentData = [];
let filteredData = [];
let currentView = 'table';

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeColumnControls();
    loadTableData();
    
    // Initialize theme-aware elements
    updateThemeAwareElements();
    
    // Listen for theme changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                updateThemeAwareElements();
            }
        });
    });
    
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-bs-theme']
    });
});

function updateThemeAwareElements() {
    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    
    // Update any theme-specific elements if needed
    const loadingSpinner = document.querySelector('.spinner-border');
    if (loadingSpinner) {
        loadingSpinner.className = isDark ? 'spinner-border text-light' : 'spinner-border text-primary';
    }
    
    // Update empty state icon color
    const emptyIcon = document.querySelector('#emptyState i');
    if (emptyIcon) {
        emptyIcon.style.color = isDark ? '#495057' : '#dee2e6';
    }
}

function initializeColumnControls() {
    const container = document.getElementById('columnGroupControls');
    
    for (const [groupId, group] of Object.entries(COLUMN_GROUPS)) {
        const div = document.createElement('div');
        div.className = 'form-check mb-2';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" id="group_${groupId}" 
                   ${group.visible ? 'checked' : ''} onchange="toggleColumnGroup('${groupId}')">
            <label class="form-check-label d-flex justify-content-between align-items-center" for="group_${groupId}">
                <span class="d-flex align-items-center">
                    <i class="bi bi-circle-fill me-2" style="font-size: 0.5rem; color: ${group.color};"></i>
                    <span>${group.name}</span>
                </span>
                <span class="badge bg-secondary">${group.columns.length}</span>
            </label>
        `;
        container.appendChild(div);
    }
}

function toggleColumnGroup(groupId) {
    const checkbox = document.getElementById(`group_${groupId}`);
    COLUMN_GROUPS[groupId].visible = checkbox.checked;
    
    if (currentView === 'table') {
        updateTableDisplay();
    } else {
        displayCards();
    }
}

function switchView(viewType) {
    currentView = viewType;
    
    if (viewType === 'table') {
        document.getElementById('tableViewContainer').style.display = 'block';
        document.getElementById('cardViewContainer').style.display = 'none';
        updateTableDisplay();
    } else {
        document.getElementById('tableViewContainer').style.display = 'none';
        document.getElementById('cardViewContainer').style.display = 'block';
        displayCards();
    }
}

function loadTableData() {
    const table = document.getElementById('tableSelector').value;
    showLoading();
    
    fetch(`/api/database/table/${table}/data`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentData = data.data || [];
                filteredData = [...currentData];
                updateStats();
                updateDeviceTypeFilter();
                
                if (currentView === 'table') {
                    updateTableDisplay();
                } else {
                    displayCards();
                }
                
                updateResultCount();
                hideLoading();
            } else {
                showError(data.error || 'Failed to load data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Network error loading data');
        });
}

function updateTableDisplay() {
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    
    // Get visible columns
    const visibleColumns = [];
    for (const [groupId, group] of Object.entries(COLUMN_GROUPS)) {
        if (group.visible) {
            visibleColumns.push(...group.columns);
        }
    }
    
    // Create header
    thead.innerHTML = `
        <tr>
            ${visibleColumns.map(col => `<th class="text-nowrap">${formatColumnName(col)}</th>`).join('')}
            <th width="100">Actions</th>
        </tr>
    `;
    
    // Create rows
    tbody.innerHTML = '';
    filteredData.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            ${visibleColumns.map(col => {
                const value = formatCellValue(row[col], col);
                return `<td class="truncate-text" title="${row[col] || 'NULL'}">${value}</td>`;
            }).join('')}
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm" onclick="viewRecord(${index})" 
                            title="View Details" aria-label="View record details">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="editRecord(${index})" 
                            title="Edit" aria-label="Edit record">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function displayCards() {
    const container = document.getElementById('cardContent');
    container.innerHTML = '';
    
    filteredData.forEach((server, index) => {
        const card = createServerCard(server, index);
        const col = document.createElement('div');
        col.className = 'col-lg-4 col-md-6';
        col.appendChild(card);
        container.appendChild(col);
    });
}

function createServerCard(server, index) {
    const card = document.createElement('div');
    card.className = 'card server-card h-100';
    
    const statusColor = getStatusColor(server.status_name);
    const workflowColor = getWorkflowStatusColor(server.workflow_status);
    
    card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-server"></i> ${server.server_id || 'Unknown ID'}
            </h6>
            <div class="d-flex gap-1">
                <span class="badge ${statusColor}">${server.status_name || 'Unknown'}</span>
                ${server.workflow_status ? `<span class="badge ${workflowColor}">${server.workflow_status}</span>` : ''}
            </div>
        </div>
        
        <div class="card-body">
            <!-- Basic Information -->
            <div class="field-group">
                <h6><i class="bi bi-info-circle"></i> Basic Info</h6>
                <div class="field-row">
                    <span class="field-label">Device Type:</span>
                    <span class="field-value">${server.device_type || 'Not set'}</span>
                </div>
                <div class="field-row">
                    <span class="field-label">Server Type:</span>
                    <span class="field-value">${server.server_type || 'Not set'}</span>
                </div>
                <div class="field-row">
                    <span class="field-label">Model:</span>
                    <span class="field-value">${server.server_model || 'Unknown'}</span>
                </div>
            </div>
            
            <!-- Network Information -->
            ${server.ip_address ? `
            <div class="field-group">
                <h6><i class="bi bi-network-widescreen"></i> Network</h6>
                <div class="field-row">
                    <span class="field-label">IP Address:</span>
                    <span class="field-value">${server.ip_address}</span>
                </div>
                ${server.ipmi_address ? `
                <div class="field-row">
                    <span class="field-label">IPMI Address:</span>
                    <span class="field-value">${server.ipmi_address}</span>
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            <!-- Workflow Information -->
            ${(server.assigned_role || server.commissioning_status) ? `
            <div class="field-group">
                <h6><i class="bi bi-diagram-3"></i> Workflow</h6>
                ${server.assigned_role ? `
                <div class="field-row">
                    <span class="field-label">Role:</span>
                    <span class="field-value">${server.assigned_role}</span>
                </div>
                ` : ''}
                ${server.commissioning_status ? `
                <div class="field-row">
                    <span class="field-label">Commissioning:</span>
                    <span class="field-value">${server.commissioning_status}</span>
                </div>
                ` : ''}
            </div>
            ` : ''}
        </div>
        
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    Updated: ${server.updated_at ? new Date(server.updated_at).toLocaleDateString() : 'Never'}
                </small>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewRecord(${index})" 
                            aria-label="View record details">
                        <i class="bi bi-eye"></i> View
                    </button>
                    <button class="btn btn-outline-secondary" onclick="editRecord(${index})" 
                            aria-label="Edit record">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

function formatColumnName(column) {
    return column.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatCellValue(value, column) {
    if (value === null || value === undefined || value === '') {
        return '<span class="text-null">NULL</span>';
    }
    
    if (column.includes('_at') && value) {
        return `<span class="text-timestamp">${new Date(value).toLocaleDateString()}</span>`;
    }
    
    if (column === 'status_name') {
        const color = getStatusColor(value);
        return `<span class="badge ${color}">${value}</span>`;
    }
    
    if (column === 'workflow_status' && value) {
        const color = getWorkflowStatusColor(value);
        return `<span class="badge ${color}">${value}</span>`;
    }
    
    if (typeof value === 'string' && value.length > 30) {
        return value.substring(0, 30) + '...';
    }
    
    return value;
}

function getStatusColor(status) {
    // Use Bootstrap's semantic colors that work well in both themes
    switch (status?.toLowerCase()) {
        case 'ready': return 'bg-success text-white';
        case 'deployed': return 'bg-primary text-white';
        case 'commissioning': return 'bg-warning text-dark';
        case 'failed': case 'failed commissioning': return 'bg-danger text-white';
        default: return 'bg-secondary text-white';
    }
}

function getWorkflowStatusColor(status) {
    // Use Bootstrap's semantic colors that work well in both themes
    switch (status?.toLowerCase()) {
        case 'completed': return 'bg-success text-white';
        case 'running': return 'bg-info text-white';
        case 'pending': return 'bg-warning text-dark';
        case 'failed': return 'bg-danger text-white';
        default: return 'bg-secondary text-white';
    }
}

function filterData() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const deviceTypeFilter = document.getElementById('deviceTypeFilter').value;
    
    filteredData = currentData.filter(server => {
        // Search filter
        const matchesSearch = !searchTerm || Object.values(server).some(value => 
            value && value.toString().toLowerCase().includes(searchTerm)
        );
        
        // Status filter
        const matchesStatus = !statusFilter || server.status_name === statusFilter;
        
        // Device type filter
        const matchesDeviceType = !deviceTypeFilter || server.device_type === deviceTypeFilter;
        
        return matchesSearch && matchesStatus && matchesDeviceType;
    });
    
    updateResultCount();
    
    if (currentView === 'table') {
        updateTableDisplay();
    } else {
        displayCards();
    }
}

function updateStats() {
    const totalServers = currentData.length;
    const readyServers = currentData.filter(s => s.status_name === 'Ready').length;
    const commissioningServers = currentData.filter(s => s.status_name === 'Commissioning').length;
    
    document.getElementById('total-servers').textContent = totalServers;
    document.getElementById('ready-servers').textContent = readyServers;
    document.getElementById('commissioning-servers').textContent = commissioningServers;
}

function updateDeviceTypeFilter() {
    const select = document.getElementById('deviceTypeFilter');
    const deviceTypes = [...new Set(currentData.map(s => s.device_type).filter(Boolean))];
    
    select.innerHTML = '<option value="">All Device Types</option>';
    deviceTypes.forEach(type => {
        select.innerHTML += `<option value="${type}">${type}</option>`;
    });
}

function updateResultCount() {
    document.getElementById('resultCount').textContent = filteredData.length;
}

function refreshData() {
    loadTableData();
}

function showLoading() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('tableViewContainer').style.display = 'none';
    document.getElementById('cardViewContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingState').style.display = 'none';
    if (currentView === 'table') {
        document.getElementById('tableViewContainer').style.display = 'block';
    } else {
        document.getElementById('cardViewContainer').style.display = 'block';
    }
}

function showError(message) {
    console.error('Database error:', message);
    // Could show a toast or alert here
}

function viewRecord(index) {
    const server = filteredData[index];
    // TODO: Implement detailed view modal
    console.log('View server:', server);
}

function editRecord(index) {
    const server = filteredData[index];
    // TODO: Implement edit modal
    console.log('Edit server:', server);
}

// Theme support functions
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-bs-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-bs-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    const icon = document.getElementById('themeIcon');
    if (icon) {
        icon.className = theme === 'dark' ? 'bi bi-moon-fill' : 'bi bi-sun-fill';
    }
}

// Initialize theme icon on load
document.addEventListener('DOMContentLoaded', function() {
    const currentTheme = document.documentElement.getAttribute('data-bs-theme');
    updateThemeIcon(currentTheme);
});
</script>
</body>
</html>
