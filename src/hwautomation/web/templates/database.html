{% extends "base.html" %}

{% block title %}Database Management - HWAutomation GUI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="bi bi-database"></i> Database Management
            </h1>
        </div>
    </div>

    <!-- Database Overview -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle"></i> Database Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="db-status">
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-indicator online me-2"></span>
                            <strong>Status:</strong> 
                            <span class="ms-2 text-success" id="db-status-text">Connected</span>
                        </div>
                        <div class="mb-2">
                            <strong>Type:</strong> <span class="ms-2">SQLite</span>
                        </div>
                        <div class="mb-2">
                            <strong>Version:</strong> <span class="ms-2" id="db-version">-</span>
                        </div>
                        <div class="mb-2">
                            <strong>Size:</strong> <span class="ms-2" id="db-size">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart"></i> Database Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="stat-item">
                                <h4 class="mb-1" id="total-servers">0</h4>
                                <small class="text-muted">Servers</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <h4 class="mb-1" id="total-tables">0</h4>
                                <small class="text-muted">Tables</small>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <div class="stat-item">
                                <h4 class="mb-1" id="migration-version">0</h4>
                                <small class="text-muted">Schema Version</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <h4 class="mb-1" id="power-history">0</h4>
                                <small class="text-muted">Power Events</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear"></i> Database Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshDatabaseInfo()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Info
                        </button>
                        <button class="btn btn-outline-success" onclick="runMigrations()">
                            <i class="bi bi-arrow-up"></i> Run Migrations
                        </button>
                        <button class="btn btn-outline-info" onclick="exportDatabase()">
                            <i class="bi bi-download"></i> Export Data
                        </button>
                        <button class="btn btn-outline-warning" onclick="createBackup()">
                            <i class="bi bi-shield-check"></i> Create Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Selection and Data View -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table"></i> Database Tables
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="tableSelector" style="width: auto;" onchange="loadTableData()">
                            <option value="">Select a table...</option>
                            <option value="servers">Servers</option>
                            <option value="power_state_history">Power State History</option>
                            <option value="schema_migrations">Schema Migrations</option>
                        </select>
                        <button class="btn btn-success btn-sm" onclick="showAddRecordModal()" id="addRecordBtn" disabled>
                            <i class="bi bi-plus-circle"></i> Add Record
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Table Info -->
                    <div id="table-info" style="display: none;" class="mb-3">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">Table:</small>
                                <div class="fw-bold" id="current-table-name">-</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Records:</small>
                                <div class="fw-bold" id="record-count">-</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Columns:</small>
                                <div class="fw-bold" id="column-count">-</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Last Updated:</small>
                                <div class="fw-bold" id="last-updated">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="table-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading table data...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading table data...</p>
                    </div>

                    <!-- Table Data -->
                    <div id="table-data-container" style="display: none;" class="database-table">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover table-striped table-sm" id="dataTable">
                                <thead class="sticky-top" id="dataTableHead">
                                    <!-- Headers will be populated dynamically -->
                                </thead>
                                <tbody id="dataTableBody">
                                    <!-- Data will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="table-empty" style="display: none;" class="text-center py-4">
                        <i class="bi bi-database" style="font-size: 3rem; color: #dee2e6;"></i>
                        <h5 class="mt-3 text-muted">No Table Selected</h5>
                        <p class="text-muted">Select a table from the dropdown to view its contents.</p>
                    </div>

                    <!-- Error State -->
                    <div id="table-error" style="display: none;" class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Error loading table data:</strong>
                        <span id="table-error-text"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Migration Status -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history"></i> Migration History
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive database-table">
                        <table class="table table-striped table-sm" id="migrationsTable">
                            <thead>
                                <tr>
                                    <th>Version</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Applied At</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="migrationsTableBody">
                                <!-- Migration data will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Record Modal -->
<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recordModalTitle">Add Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close modal"></button>
            </div>
            <div class="modal-body">
                <form id="recordForm">
                    <div id="recordFormFields">
                        <!-- Form fields will be generated dynamically -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteRecordBtn" onclick="deleteRecord()" style="display: none;">
                    <i class="bi bi-trash"></i> Delete
                </button>
                <button type="button" class="btn btn-primary" id="saveRecordBtn" onclick="saveRecord()">
                    <i class="bi bi-check-circle"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close confirmation modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Database Management JavaScript
let currentTable = '';
let currentRecord = null;
let tableColumns = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshDatabaseInfo();
    loadMigrationHistory();
});

function refreshDatabaseInfo() {
    // Load database statistics
    fetch('/api/database/info')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDatabaseInfo(data.info);
            } else {
                showNotification('Failed to load database info', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading database info:', error);
            showNotification('Error loading database information', 'error');
        });
}

function updateDatabaseInfo(info) {
    document.getElementById('db-version').textContent = info.version || '-';
    document.getElementById('db-size').textContent = info.size || '-';
    document.getElementById('total-servers').textContent = info.server_count || 0;
    document.getElementById('total-tables').textContent = info.table_count || 0;
    document.getElementById('migration-version').textContent = info.schema_version || 0;
    document.getElementById('power-history').textContent = info.power_events || 0;
}

function loadMigrationHistory() {
    fetch('/api/database/migrations')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMigrationsTable(data.migrations);
            } else {
                showNotification('Failed to load migration history', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading migrations:', error);
        });
}

function updateMigrationsTable(migrations) {
    const tbody = document.getElementById('migrationsTableBody');
    tbody.innerHTML = '';
    
    const migrationDescriptions = {
        1: 'Initial database schema setup',
        2: 'Add IPMI-related fields', 
        3: 'Add timestamp tracking',
        4: 'Add server metadata fields',
        5: 'Add power state tracking'
    };
    
    // Create entries for all known migrations
    for (let i = 1; i <= 5; i++) {
        const migration = migrations.find(m => m.version === i);
        const row = document.createElement('tr');
        
        const isApplied = migration !== undefined;
        const statusBadge = isApplied ? 
            '<span class="badge bg-success">Applied</span>' : 
            '<span class="badge bg-secondary">Pending</span>';
        
        row.innerHTML = `
            <td><code>${i.toString().padStart(3, '0')}</code></td>
            <td>Migration ${i.toString().padStart(3, '0')}</td>
            <td>${statusBadge}</td>
            <td>${isApplied ? new Date(migration.applied_at).toLocaleString() : '-'}</td>
            <td>${migrationDescriptions[i] || 'Unknown migration'}</td>
        `;
        
        tbody.appendChild(row);
    }
}

function loadTableData() {
    const tableSelect = document.getElementById('tableSelector');
    const selectedTable = tableSelect.value;
    
    if (!selectedTable) {
        showEmptyState();
        return;
    }
    
    currentTable = selectedTable;
    showLoadingState();
    
    // Enable add button for user tables
    const addBtn = document.getElementById('addRecordBtn');
    addBtn.disabled = selectedTable === 'schema_migrations';
    
    fetch(`/api/database/table/${selectedTable}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTableData(data.data, data.columns);
                updateTableInfo(selectedTable, data.data.length, data.columns.length);
            } else {
                showErrorState(data.error);
            }
        })
        .catch(error => {
            console.error('Error loading table data:', error);
            showErrorState('Failed to load table data');
        });
}

function displayTableData(data, columns) {
    tableColumns = columns;
    
    const thead = document.getElementById('dataTableHead');
    const tbody = document.getElementById('dataTableBody');
    
    // Create header
    thead.innerHTML = `
        <tr>
            ${columns.map(col => `<th>${col.name}</th>`).join('')}
            <th width="120">Actions</th>
        </tr>
    `;
    
    // Create rows
    tbody.innerHTML = '';
    data.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            ${columns.map(col => {
                let value = row[col.name];
                let cssClass = '';
                
                if (value === null || value === undefined || value === '') {
                    value = 'NULL';
                    cssClass = 'text-null';
                } else if (col.name.includes('_at') && value) {
                    // Format timestamps
                    value = new Date(value).toLocaleString();
                    cssClass = 'text-timestamp';
                } else if (typeof value === 'string' && value.length > 50) {
                    // Truncate long strings
                    const fullValue = value;
                    value = value.substring(0, 50) + '...';
                    cssClass = 'text-truncate';
                    // Add title attribute for full text on hover
                    return `<td><span class="${cssClass}" title="${fullValue}">${value}</span></td>`;
                }
                
                return `<td><span class="${cssClass}">${value}</span></td>`;
            }).join('')}
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" onclick="editRecord(${index})" 
                            title="Edit" aria-label="Edit record">
                        <i class="bi bi-pencil"></i>
                    </button>
                    ${currentTable !== 'schema_migrations' ? `
                    <button class="btn btn-outline-danger" onclick="confirmDeleteRecord(${index})" 
                            title="Delete" aria-label="Delete record">
                        <i class="bi bi-trash"></i>
                    </button>
                    ` : ''}
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    showTableData();
}

function updateTableInfo(tableName, recordCount, columnCount) {
    document.getElementById('current-table-name').textContent = tableName;
    document.getElementById('record-count').textContent = recordCount;
    document.getElementById('column-count').textContent = columnCount;
    document.getElementById('last-updated').textContent = new Date().toLocaleString();
    document.getElementById('table-info').style.display = 'block';
}

function showLoadingState() {
    document.getElementById('table-loading').style.display = 'block';
    document.getElementById('table-data-container').style.display = 'none';
    document.getElementById('table-empty').style.display = 'none';
    document.getElementById('table-error').style.display = 'none';
    document.getElementById('table-info').style.display = 'none';
}

function showTableData() {
    document.getElementById('table-loading').style.display = 'none';
    document.getElementById('table-data-container').style.display = 'block';
    document.getElementById('table-empty').style.display = 'none';
    document.getElementById('table-error').style.display = 'none';
}

function showEmptyState() {
    document.getElementById('table-loading').style.display = 'none';
    document.getElementById('table-data-container').style.display = 'none';
    document.getElementById('table-empty').style.display = 'block';
    document.getElementById('table-error').style.display = 'none';
    document.getElementById('table-info').style.display = 'none';
    document.getElementById('addRecordBtn').disabled = true;
}

function showErrorState(error) {
    document.getElementById('table-loading').style.display = 'none';
    document.getElementById('table-data-container').style.display = 'none';
    document.getElementById('table-empty').style.display = 'none';
    document.getElementById('table-error').style.display = 'block';
    document.getElementById('table-error-text').textContent = error;
    document.getElementById('table-info').style.display = 'none';
}

function showAddRecordModal() {
    if (!currentTable) return;
    
    currentRecord = null;
    document.getElementById('recordModalTitle').textContent = `Add ${currentTable.slice(0, -1)}`;
    document.getElementById('deleteRecordBtn').style.display = 'none';
    document.getElementById('saveRecordBtn').innerHTML = '<i class="bi bi-plus-circle"></i> Add Record';
    
    generateRecordForm();
    
    const modal = new bootstrap.Modal(document.getElementById('recordModal'));
    modal.show();
}

function editRecord(index) {
    const tbody = document.getElementById('dataTableBody');
    const row = tbody.children[index];
    const cells = Array.from(row.children);
    
    // Extract record data
    currentRecord = {};
    tableColumns.forEach((col, i) => {
        let cellText = cells[i].textContent;
        if (cellText === 'NULL') {
            currentRecord[col.name] = null;
        } else {
            currentRecord[col.name] = cellText;
        }
    });
    
    document.getElementById('recordModalTitle').textContent = `Edit ${currentTable.slice(0, -1)}`;
    document.getElementById('deleteRecordBtn').style.display = currentTable !== 'schema_migrations' ? 'inline-block' : 'none';
    document.getElementById('saveRecordBtn').innerHTML = '<i class="bi bi-check-circle"></i> Update Record';
    
    generateRecordForm(currentRecord);
    
    const modal = new bootstrap.Modal(document.getElementById('recordModal'));
    modal.show();
}

function generateRecordForm(recordData = null) {
    const formFields = document.getElementById('recordFormFields');
    formFields.innerHTML = '';
    
    tableColumns.forEach(column => {
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'mb-3';
        
        const isReadOnly = column.name.includes('_at') || 
                          column.name === 'id' || 
                          (currentTable === 'servers' && column.name === 'server_id' && recordData);
        
        let inputType = 'text';
        let inputClass = 'form-control';
        
        if (column.type && column.type.includes('INTEGER')) {
            inputType = 'number';
        } else if (column.name.includes('password')) {
            inputType = 'password';
        } else if (column.name.includes('_at')) {
            inputType = 'datetime-local';
        }
        
        const value = recordData && recordData[column.name] ? recordData[column.name] : '';
        
        fieldDiv.innerHTML = `
            <label for="field_${column.name}" class="form-label">
                ${column.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                ${column.notnull ? '<span class="text-danger">*</span>' : ''}
            </label>
            <input type="${inputType}" 
                   class="${inputClass}" 
                   id="field_${column.name}" 
                   name="${column.name}"
                   value="${value}"
                   ${isReadOnly ? 'readonly' : ''}
                   ${column.notnull ? 'required' : ''}>
            ${column.dflt_value ? `<div class="form-text">Default: ${column.dflt_value}</div>` : ''}
        `;
        
        formFields.appendChild(fieldDiv);
    });
}

function saveRecord() {
    const form = document.getElementById('recordForm');
    const formData = new FormData(form);
    const data = {};
    
    // Convert FormData to object
    for (let [key, value] of formData.entries()) {
        data[key] = value || null;
    }
    
    const isEdit = currentRecord !== null;
    const method = isEdit ? 'PUT' : 'POST';
    const url = `/api/database/table/${currentTable}${isEdit ? `/${data[getPrimaryKey()]}` : ''}`;
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification(`Record ${isEdit ? 'updated' : 'added'} successfully!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
            loadTableData(); // Refresh table
        } else {
            showNotification(`Failed to ${isEdit ? 'update' : 'add'} record: ${result.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving record:', error);
        showNotification('Error saving record', 'error');
    });
}

function confirmDeleteRecord(index) {
    const tbody = document.getElementById('dataTableBody');
    const row = tbody.children[index];
    const primaryKey = getPrimaryKey();
    const recordId = row.children[tableColumns.findIndex(col => col.name === primaryKey)].textContent;
    
    currentRecord = { [primaryKey]: recordId };
    
    document.getElementById('confirmModalTitle').textContent = 'Delete Record';
    document.getElementById('confirmModalMessage').textContent = 
        `Are you sure you want to delete this record? This action cannot be undone.`;
    
    document.getElementById('confirmActionBtn').onclick = deleteRecord;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

function deleteRecord() {
    if (!currentRecord) return;
    
    const primaryKey = getPrimaryKey();
    const recordId = currentRecord[primaryKey];
    
    fetch(`/api/database/table/${currentTable}/${recordId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Record deleted successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            if (document.getElementById('recordModal').classList.contains('show')) {
                bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
            }
            loadTableData(); // Refresh table
        } else {
            showNotification(`Failed to delete record: ${result.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting record:', error);
        showNotification('Error deleting record', 'error');
    });
}

function getPrimaryKey() {
    // Determine primary key based on table
    switch (currentTable) {
        case 'servers':
            return 'server_id';
        case 'power_state_history':
            return 'id';
        case 'schema_migrations':
            return 'id';
        default:
            return 'id';
    }
}

function runMigrations() {
    if (!confirm('Are you sure you want to run database migrations? This will update the database schema.')) {
        return;
    }
    
    showNotification('Running database migrations...', 'info');
    
    fetch('/api/database/migrate', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Migrations completed successfully!', 'success');
            refreshDatabaseInfo();
            loadMigrationHistory();
        } else {
            showNotification(`Migration failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error running migrations:', error);
        showNotification('Error running migrations', 'error');
    });
}

function createBackup() {
    showNotification('Creating database backup...', 'info');
    
    fetch('/api/database/backup', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Database backup created: ${data.backup_file}`, 'success');
        } else {
            showNotification(`Backup failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating backup:', error);
        showNotification('Error creating backup', 'error');
    });
}

function exportDatabase() {
    showNotification('Exporting database...', 'info');
    
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
    const link = document.createElement('a');
    link.href = `/api/database/export?format=json&timestamp=${timestamp}`;
    link.download = `hw_automation_export_${timestamp}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Database export started', 'success');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';
    
    notification.innerHTML = `
        <i class="bi bi-${icon}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close notification"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
