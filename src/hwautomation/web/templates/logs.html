{% extends "base.html" %}

{% block title %}System Logs - HWAutomation{% endblock %}
{% block nav_title %} - System Logs{% endblock %}

{% block extra_css %}
.log-controls { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.log-viewer { background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; height: 500px; overflow-y: auto; padding: 15px; border-radius: 5px; }
[data-bs-theme="dark"] .log-controls { background: #2d3035; }
[data-bs-theme="dark"] .log-viewer { background: #0d1117; }
.log-entry { margin-bottom: 2px; }
.log-debug { color: #6c757d; }
.log-info { color: #17a2b8; }
.log-warning { color: #ffc107; }
.log-error { color: #dc3545; }
.log-critical { color: #721c24; background-color: #f8d7da; }
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-journal-text"></i> System Logs
        </h1>
    </div>
</div>

<!-- Log Controls -->
<div class="log-controls">
    <h4><i class="bi bi-funnel"></i> Log Filters & Controls</h4>
    <div class="row">
        <div class="col-md-3">
            <label for="logLevel" class="form-label">Log Level</label>
            <select class="form-select" id="logLevel">
                <option value="">All Levels</option>
                <option value="DEBUG">Debug</option>
                <option value="INFO" selected>Info</option>
                <option value="WARNING">Warning</option>
                <option value="ERROR">Error</option>
                <option value="CRITICAL">Critical</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="logComponent" class="form-label">Component</label>
            <select class="form-select" id="logComponent">
                <option value="">All Components</option>
                <option value="web">Web Interface</option>
                <option value="database">Database</option>
                <option value="bios">BIOS Management</option>
                <option value="workflow">Workflow</option>
                <option value="maas">MaaS</option>
                <option value="firmware">Firmware</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="logLines" class="form-label">Lines to Show</label>
            <select class="form-select" id="logLines">
                <option value="100">Last 100 lines</option>
                <option value="500" selected>Last 500 lines</option>
                <option value="1000">Last 1000 lines</option>
                <option value="all">All lines</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div>
                <button class="btn btn-primary" id="refreshLogs">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-outline-secondary" id="clearLogs">
                    <i class="bi bi-trash"></i> Clear
                </button>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                <label class="form-check-label" for="autoRefresh">
                    Auto-refresh every 10 seconds
                </label>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-outline-success btn-sm" id="downloadLogs">
                <i class="bi bi-download"></i> Download Logs
            </button>
        </div>
    </div>
</div>

<!-- Log Viewer -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-terminal"></i> Log Output
                </h5>
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-2" id="logCount">0 entries</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="followLogs" checked>
                        <label class="form-check-label" for="followLogs">Follow</label>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="log-viewer" class="log-viewer">
                    <div class="log-entry log-info">[INFO] Loading system logs...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Search -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-search"></i> Search Logs
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="searchQuery"
                               placeholder="Search log entries... (regex supported)">
                    </div>
                    <div class="col-md-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="regexSearch">
                            <label class="form-check-label" for="regexSearch">Regex</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100" id="searchLogs">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
                <div id="searchResults" class="mt-3" style="display: none;">
                    <h6>Search Results:</h6>
                    <div id="searchOutput" class="log-viewer" style="height: 200px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval;
let isFollowing = true;

// UI Elements
const logViewer = document.getElementById('log-viewer');
const logLevel = document.getElementById('logLevel');
const logComponent = document.getElementById('logComponent');
const logLines = document.getElementById('logLines');
const refreshLogs = document.getElementById('refreshLogs');
const clearLogs = document.getElementById('clearLogs');
const autoRefresh = document.getElementById('autoRefresh');
const followLogs = document.getElementById('followLogs');
const logCount = document.getElementById('logCount');
const downloadLogs = document.getElementById('downloadLogs');
const searchQuery = document.getElementById('searchQuery');
const regexSearch = document.getElementById('regexSearch');
const searchLogs = document.getElementById('searchLogs');
const searchResults = document.getElementById('searchResults');
const searchOutput = document.getElementById('searchOutput');

// Load logs function
async function loadLogs() {
    try {
        refreshLogs.disabled = true;
        refreshLogs.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';

        const params = new URLSearchParams({
            level: logLevel.value,
            component: logComponent.value,
            lines: logLines.value
        });

        const response = await fetch(`/api/logs?${params}`);
        const data = await response.json();

        if (response.ok) {
            displayLogs(data.logs);
            logCount.textContent = `${data.logs.length} entries`;
        } else {
            logViewer.innerHTML = `<div class="log-entry log-error">[ERROR] Failed to load logs: ${data.error}</div>`;
        }
    } catch (error) {
        logViewer.innerHTML = `<div class="log-entry log-error">[ERROR] Failed to load logs: ${error.message}</div>`;
    }

    refreshLogs.disabled = false;
    refreshLogs.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh';
}

// Display logs function
function displayLogs(logs) {
    if (logs.length === 0) {
        logViewer.innerHTML = '<div class="log-entry log-info">[INFO] No log entries found</div>';
        return;
    }

    let html = '';
    logs.forEach(log => {
        const levelClass = `log-${log.level.toLowerCase()}`;
        const timestamp = new Date(log.timestamp).toLocaleString();
        html += `<div class="log-entry ${levelClass}">[${timestamp}] [${log.level}] ${log.component}: ${log.message}</div>`;
    });

    logViewer.innerHTML = html;

    if (isFollowing) {
        logViewer.scrollTop = logViewer.scrollHeight;
    }
}

// Search logs function
async function performSearch() {
    if (!searchQuery.value.trim()) {
        searchResults.style.display = 'none';
        return;
    }

    try {
        const params = new URLSearchParams({
            query: searchQuery.value,
            regex: regexSearch.checked,
            level: logLevel.value,
            component: logComponent.value
        });

        const response = await fetch(`/api/logs/search?${params}`);
        const data = await response.json();

        if (response.ok) {
            let html = '';
            data.results.forEach(log => {
                const levelClass = `log-${log.level.toLowerCase()}`;
                const timestamp = new Date(log.timestamp).toLocaleString();
                html += `<div class="log-entry ${levelClass}">[${timestamp}] [${log.level}] ${log.component}: ${log.message}</div>`;
            });

            searchOutput.innerHTML = html || '<div class="log-entry log-info">[INFO] No matches found</div>';
            searchResults.style.display = 'block';
        } else {
            searchOutput.innerHTML = `<div class="log-entry log-error">[ERROR] Search failed: ${data.error}</div>`;
            searchResults.style.display = 'block';
        }
    } catch (error) {
        searchOutput.innerHTML = `<div class="log-entry log-error">[ERROR] Search failed: ${error.message}</div>`;
        searchResults.style.display = 'block';
    }
}

// Clear logs function
async function clearSystemLogs() {
    if (!confirm('Are you sure you want to clear all system logs? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch('/api/logs/clear', { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
            logViewer.innerHTML = '<div class="log-entry log-info">[INFO] System logs cleared</div>';
            logCount.textContent = '0 entries';
        } else {
            alert(`Failed to clear logs: ${data.error}`);
        }
    } catch (error) {
        alert(`Failed to clear logs: ${error.message}`);
    }
}

// Download logs function
function downloadSystemLogs() {
    const params = new URLSearchParams({
        level: logLevel.value,
        component: logComponent.value,
        lines: logLines.value,
        format: 'text'
    });

    window.open(`/api/logs/download?${params}`, '_blank');
}

// Auto-refresh setup
function setupAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }

    if (autoRefresh.checked) {
        autoRefreshInterval = setInterval(loadLogs, 10000);
    }
}

// Event listeners
refreshLogs.addEventListener('click', loadLogs);
clearLogs.addEventListener('click', clearSystemLogs);
downloadLogs.addEventListener('click', downloadSystemLogs);
searchLogs.addEventListener('click', performSearch);

logLevel.addEventListener('change', loadLogs);
logComponent.addEventListener('change', loadLogs);
logLines.addEventListener('change', loadLogs);

autoRefresh.addEventListener('change', setupAutoRefresh);

followLogs.addEventListener('change', function() {
    isFollowing = this.checked;
    if (isFollowing) {
        logViewer.scrollTop = logViewer.scrollHeight;
    }
});

// Search on Enter key
searchQuery.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performSearch();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    setupAutoRefresh();
});
</script>
{% endblock %}
