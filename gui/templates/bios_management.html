{% extends "base.html" %}

{% block title %}BIOS Management - HWAutomation GUI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-cpu"></i> BIOS Configuration Management
        </h1>
    </div>
</div>

<!-- Configuration Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-download"></i> Pull Configuration
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Pull current BIOS configuration from a target system.</p>
                <form id="pullConfigForm">
                    <div class="mb-3">
                        <label for="pullTargetIp" class="form-label">Target IP Address</label>
                        <input type="text" class="form-control" id="pullTargetIp" required
                               placeholder="192.168.1.100">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pullUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="pullUsername" 
                                       value="ADMIN">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pullPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="pullPassword">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-download"></i> Pull Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-upload"></i> Apply Configuration
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Apply BIOS configuration using smart pull-edit-push approach.</p>
                <form id="applyConfigForm">
                    <div class="mb-3">
                        <label for="applyDeviceType" class="form-label">Device Type</label>
                        <select class="form-select" id="applyDeviceType" required>
                            <option value="">Select device type...</option>
                            {% for device_type in device_types %}
                            <option value="{{ device_type }}">{{ device_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="applyTargetIp" class="form-label">Target IP Address</label>
                        <input type="text" class="form-control" id="applyTargetIp" required
                               placeholder="192.168.1.100">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="applyUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="applyUsername" 
                                       value="ADMIN">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="applyPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="applyPassword">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dryRun" checked>
                            <label class="form-check-label" for="dryRun">
                                Dry Run (preview changes only)
                            </label>
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                        <button type="button" class="btn btn-outline-info" onclick="testConnection()">
                            <i class="bi bi-wifi"></i> Test Connection
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-upload"></i> Apply Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Progress Card -->
<div class="row mb-4" id="progressCard" style="display: none;">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i> Operation Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progressBar" style="width: 0%"></div>
                </div>
                <p id="progressMessage" class="mb-0">Initializing...</p>
            </div>
        </div>
    </div>
</div>

<!-- Results Card -->
<div class="row mb-4" id="resultsCard" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-check-circle"></i> Operation Results
                </h5>
            </div>
            <div class="card-body">
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Device Types Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul"></i> Device Types & Templates
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Device Type</th>
                                <th>Description</th>
                                <th>Motherboards</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deviceTypesTable">
                            {% for device_type in device_types %}
                            <tr>
                                <td><strong>{{ device_type }}</strong></td>
                                <td id="desc-{{ device_type }}">Loading...</td>
                                <td id="mb-{{ device_type }}">Loading...</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="viewDeviceConfig('{{ device_type }}')">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                        <button class="btn btn-outline-success" 
                                                onclick="generateXML('{{ device_type }}')">
                                            <i class="bi bi-file-code"></i> XML
                                        </button>
                                        <button class="btn btn-outline-warning" 
                                                onclick="quickApply('{{ device_type }}')">
                                            <i class="bi bi-lightning"></i> Quick Apply
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% include 'modals/device_config_modal.html' %}
{% include 'modals/xml_modal.html' %}
{% include 'modals/quick_apply_modal.html' %}

{% endblock %}

{% block extra_scripts %}
<script>
// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    setupBiosSocketHandlers();
    loadDeviceInformation();
    setupFormHandlers();
});

function setupBiosSocketHandlers() {
    if (!socket) {
        console.error('Global socket not available');
        return;
    }
    
    socket.on('config_progress', function(data) {
        updateProgress(data);
    });
    
    socket.on('connection_test', function(data) {
        updateConnectionTest(data);
    });
    
    // Note: connected handler is already set up in app.js
    console.log('BIOS management socket handlers set up');
}

function setupFormHandlers() {
    // Pull config form
    document.getElementById('pullConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        pullConfiguration();
    });
    
    // Apply config form
    document.getElementById('applyConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        applyConfiguration();
    });
}

function loadDeviceInformation() {
    fetch('/api/device-types')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                data.data.forEach(device => {
                    const descCell = document.getElementById(`desc-${device.name}`);
                    const mbCell = document.getElementById(`mb-${device.name}`);
                    
                    if (descCell) descCell.textContent = device.description;
                    if (mbCell) mbCell.textContent = device.motherboards.join(', ') || 'None specified';
                });
            }
        })
        .catch(error => {
            console.error('Error loading device information:', error);
        });
}

function pullConfiguration() {
    const targetIp = document.getElementById('pullTargetIp').value;
    const username = document.getElementById('pullUsername').value;
    const password = document.getElementById('pullPassword').value;
    
    showProgress('Pulling configuration...');
    
    fetch('/api/pull-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_ip: targetIp,
            username: username,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        if (data.success) {
            showResults('success', 'Configuration pulled successfully', {
                xml: data.data.xml,
                target_ip: data.data.target_ip
            });
        } else {
            showResults('error', 'Failed to pull configuration', {
                error: data.error
            });
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error:', error);
        showResults('error', 'Error pulling configuration', {error: error.message});
    });
}

function applyConfiguration() {
    const deviceType = document.getElementById('applyDeviceType').value;
    const targetIp = document.getElementById('applyTargetIp').value;
    const username = document.getElementById('applyUsername').value;
    const password = document.getElementById('applyPassword').value;
    const dryRun = document.getElementById('dryRun').checked;
    
    showProgress('Applying configuration...');
    
    fetch('/api/apply-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device_type: deviceType,
            target_ip: targetIp,
            username: username,
            password: password,
            dry_run: dryRun
        })
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        if (data.success) {
            showResults('success', 
                dryRun ? 'Dry run completed successfully' : 'Configuration applied successfully', 
                data
            );
        } else {
            showResults('error', 'Failed to apply configuration', data);
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error:', error);
        showResults('error', 'Error applying configuration', {error: error.message});
    });
}

function testConnection() {
    const targetIp = document.getElementById('applyTargetIp').value;
    const username = document.getElementById('applyUsername').value;
    const password = document.getElementById('applyPassword').value;
    
    if (!targetIp) {
        alert('Please enter a target IP address');
        return;
    }
    
    showProgress('Testing connection...');
    
    fetch('/api/validate-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_ip: targetIp,
            username: username,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        if (data.success) {
            showResults('success', 'Connection test successful', data);
        } else {
            showResults('error', 'Connection test failed', data);
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error:', error);
        showResults('error', 'Connection test error', {error: error.message});
    });
}

function showProgress(message) {
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('resultsCard').style.display = 'none';
    document.getElementById('progressMessage').textContent = message;
    document.getElementById('progressBar').style.width = '25%';
}

function updateProgress(data) {
    const progressCard = document.getElementById('progressCard');
    const progressMessage = document.getElementById('progressMessage');
    const progressBar = document.getElementById('progressBar');
    
    progressCard.style.display = 'block';
    progressMessage.textContent = data.message;
    
    // Update progress bar based on stage
    const stages = {
        'connecting': 25,
        'pulling': 40,
        'applying': 60,
        'validating': 80,
        'complete': 100,
        'error': 100
    };
    
    const progress = stages[data.stage] || 50;
    progressBar.style.width = progress + '%';
    
    if (data.stage === 'error') {
        progressBar.classList.add('bg-danger');
    } else if (data.stage === 'complete') {
        progressBar.classList.add('bg-success');
    }
}

function updateConnectionTest(data) {
    updateProgress(data);
}

function hideProgress() {
    document.getElementById('progressCard').style.display = 'none';
}

function showResults(type, message, data) {
    const resultsCard = document.getElementById('resultsCard');
    const resultsContent = document.getElementById('resultsContent');
    
    let html = `<div class="alert alert-${type === 'success' ? 'success' : 'danger'}">
        <strong>${message}</strong>
    </div>`;
    
    if (data.changes_made && data.changes_made.length > 0) {
        html += '<h6>Changes Made:</h6><ul>';
        data.changes_made.forEach(change => {
            html += `<li>${change}</li>`;
        });
        html += '</ul>';
    }
    
    if (data.validation_errors && data.validation_errors.length > 0) {
        html += '<h6>Validation Errors:</h6><ul>';
        data.validation_errors.forEach(error => {
            html += `<li class="text-danger">${error}</li>`;
        });
        html += '</ul>';
    }
    
    if (data.xml) {
        html += `<h6>Configuration XML:</h6>
        <button class="btn btn-sm btn-secondary mb-2" onclick="copyToClipboard('${data.xml.replace(/'/g, "\\'")}')">
            <i class="bi bi-clipboard"></i> Copy XML
        </button>
        <pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">${escapeHtml(data.xml)}</pre>`;
    }
    
    if (data.error) {
        html += `<h6>Error Details:</h6><p class="text-danger">${data.error}</p>`;
    }
    
    resultsContent.innerHTML = html;
    resultsCard.style.display = 'block';
    
    // Scroll to results
    resultsCard.scrollIntoView({ behavior: 'smooth' });
}

function viewDeviceConfig(deviceType) {
    fetch(`/api/device-config/${deviceType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showDeviceConfigModal(deviceType, data.data);
            } else {
                alert('Error loading device configuration: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading device configuration');
        });
}

function generateXML(deviceType) {
    fetch('/api/generate-xml', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({device_type: deviceType})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showXMLModal(deviceType, data.data.xml);
        } else {
            alert('Error generating XML: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating XML');
    });
}

function quickApply(deviceType) {
    // Pre-fill the apply form
    document.getElementById('applyDeviceType').value = deviceType;
    
    // Show quick apply modal or scroll to apply form
    document.getElementById('applyConfigForm').scrollIntoView({ behavior: 'smooth' });
    
    // Highlight the form briefly
    const form = document.getElementById('applyConfigForm').parentElement.parentElement;
    form.classList.add('border-warning');
    setTimeout(() => {
        form.classList.remove('border-warning');
    }, 2000);
}

function showDeviceConfigModal(deviceType, config) {
    document.getElementById('deviceConfigModalLabel').textContent = `Configuration for ${deviceType}`;
    document.getElementById('deviceConfigContent').innerHTML = `
        <h6>Description:</h6>
        <p>${config.description || 'No description'}</p>
        
        <h6>Motherboards:</h6>
        <p>${config.motherboards ? config.motherboards.join(', ') : 'None specified'}</p>
        
        <h6>CPU Configuration:</h6>
        <pre class="bg-light p-2">${JSON.stringify(config.cpu_configs || {}, null, 2)}</pre>
        
        <h6>Memory Configuration:</h6>
        <pre class="bg-light p-2">${JSON.stringify(config.memory_configs || {}, null, 2)}</pre>
        
        <h6>Boot Configuration:</h6>
        <pre class="bg-light p-2">${JSON.stringify(config.boot_configs || {}, null, 2)}</pre>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('deviceConfigModal'));
    modal.show();
}

function showXMLModal(deviceType, xml) {
    document.getElementById('xmlModalLabel').textContent = `XML Configuration for ${deviceType}`;
    setXMLContent(xml);  // Use the new function for better XML handling
    
    const modal = new bootstrap.Modal(document.getElementById('xmlModal'));
    modal.show();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show brief success message
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
        }, 2000);
    });
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}
</script>
{% endblock %}
